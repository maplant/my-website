<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <title> preprint Scheme to the Spec Part I: Concurrent Cycle Collection</title>
    <link href="./styles.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Anonymous+Pro&display=swap" rel="stylesheet"> 
  </head>
  <body>
    <div style="margin-bottom: 10px; padding: 10px; text-align: center" class="nav-bar">
      <a href="./index.html">Home</a> | <a href="./articles.html">Articles</a> | <a href="./projects.html">Projects</a>
    </div>
    <h1> preprint Scheme to the Spec Part I: Concurrent Cycle Collection</h1>
    
by Matthew Plant
<h1>Scheme to the Spec (In Rust)</h1>
<p><strong>This is a pre-print article</strong></p>
<p>Scheme to the Spec is a series on the more complex, often overlooked (at least didactically) aspects of programming language 
implementation.</p>
<p>In this series we will dive deep into my work-in-progress implementation of R6RS scheme, <a href="https://www.github.com/maplant/scheme-rs">scheme-rs</a>,
an implementation designed to integrate seamlessly with the async-rust ecosystem.</p>
<p>Our first article discusses how to implement Garbage-Collected smart pointers that we can use both within the interpreter
and the interfacing Rust code. In later articles we will discuss topics such as tail call optimizations, implementing continuations, 
and syntax transformers. Our final article will be implementing <a href="https://www.graalvm.org/latest/graalvm-as-a-platform/language-implementation-framework/OnStackReplacement/">on-stack replacement</a> with LLVM.</p>
<h2>Part I: Garbage Collected Smart Pointers with Concurrent Cycle Collection</h2>
<p>Ten years ago I wrote an article on how to implement a conservative garbage collector for C, and I got a lot of constructive 
criticism regarding the actual usefulness of the code in that article. It only makes sense to me that on the tenth-year anniversary 
of writing that article I should try to fix my error by writing a garbage collector that is precise, does not make assumptions, and 
actually works (hopefully). </p>
<h2>The <code>Gc&lt;T&gt;</code> Smart Pointer</h2>
<p>Before we can start writing code, we have to figure out what goals we want to accomplish. More specifically, what do we want our 
<code>Gc&lt;T&gt;</code> type to <em>do</em>? How does it <em>behave</em>? What kind of <em>data can it contain</em>?</p>
<p>I want the <code>Gc&lt;T&gt;</code> type to work as follows:</p>
<ul>
<li>The API for the <code>Gc&lt;T&gt;</code> should behave similarly to a <code>Arc&lt;tokio::sync::RwLock&lt;T&gt;&gt;</code>; that is, it should support interior mutability
through a read/write lock and it should be clonable and sendable across threads.</li>
<li><code>T</code> is allowed to be <em>any</em> data type that satisfies <code>'static + Send + Sync</code>. This includes <code>Arc</code>. </li>
<li>When <code>Gc&lt;T&gt;</code> no longer has any references to it reachable from the stack, then we should clean it up properly, <em>including any cycles</em>. </li>
</ul>
<p>Now that we have an idea as to how our smart pointer should behave, we can begin our implementation. Let’s get started.</p>
<h3>Scaffolding and allocation</h3>
<p>Our Gc type will be composed of three separate types:</p>
<ul>
<li><code>Gc&lt;T&gt;</code>: User-facing type, contains a pointer to our heap allocated memory.</li>
<li><code>GcInner&lt;T&gt;</code>: The inner data type, which contains <code>T</code> and any other information we may need to keep track of the data.</li>
<li><code>GcHeader</code>: The “any other information we may need to keep track of”.</li>
</ul>
<p>To start out, we have no extra information we need to store in <code>GcHeader</code>, so we can knock that one out quickly:</p>
<pre class="code"><span class="source rust"><span class="meta struct rust"><span class="storage type struct rust">struct</span> </span><span class="meta struct rust"><span class="entity name struct rust">GcHeader</span></span><span class="punctuation terminator rust">;</span>
</span></pre>
<p><code>GcInner&lt;T&gt;</code> is just the header and the data, so that is equally simple:</p>
<pre class="code"><span class="source rust"><span class="meta struct rust"><span class="storage type struct rust">struct</span> </span><span class="meta struct rust"><span class="meta generic rust"><span class="entity name struct rust">GcInner</span><span class="meta generic rust"><span class="punctuation definition generic begin rust">&lt;</span>T<span class="punctuation definition generic end rust">&gt;</span></span></span></span><span class="meta struct rust"> </span><span class="meta struct rust"><span class="meta block rust"><span class="punctuation section block begin rust">{</span>
    <span class="variable other member rust">header</span><span class="punctuation separator rust">:</span> GcHeader,
    <span class="variable other member rust">data</span><span class="punctuation separator rust">:</span> T,
</span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span></span>
</span></pre>
<p>Now we can put it together and build our <code>Gc&lt;T&gt;</code> type. Before we get to allocating, we need to make sure that our 
data structure expresses the following things to the compiler:</p>
<h5>Variance:</h5>
<p>If we have two types <code>A</code> and <code>B</code> such that <code>A</code> is a subtype of <code>B</code>, then <code>Gc&lt;A&gt;</code> is a subtype of <code>Gc&lt;B&gt;</code>. </p>
<p>Why do we need that? Well, actually, we don’t <em>really</em>. We’d fine to specify no subtype relationship between two <code>Gc's</code>, 
as in we’d say the subtype relationship between two Gcs is <em>invariant</em>. Subtyping in Rust practically extends to 
specifying a liveness relationship; i.e., <code>&amp;'static T</code> outlives <code>for&lt;'a&gt; &amp;'a i32</code>, therefore 
<code>&amp;'static T</code> is a subtype of <code>for&lt;'a&gt; &amp;'a i32</code> as it can be placed any place the latter is accepted. </p>
<p>Accepting references for non-stacic lifetimes would dramatically complicated our task, so we are simply not going to allow for them. So variance is <em>largely</em> unimportant.</p>
<p>There is another place subtyping comes up. What about trait objects? Indeed, one can imagine the following example:</p>
<pre class="code"><span class="source rust"><span class="meta trait rust"><span class="storage type trait rust">trait</span> <span class="entity name trait rust">A</span> <span class="meta block rust"><span class="punctuation section block begin rust">{</span> <span class="meta function rust"><span class="meta function rust"><span class="storage type function rust">fn</span> </span><span class="entity name function rust">a</span></span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters begin rust">(</span><span class="keyword operator rust">&amp;</span><span class="variable parameter rust">self</span></span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters end rust">)</span></span></span></span><span class="meta function rust"> <span class="meta function return-type rust"><span class="punctuation separator rust">-&gt;</span> <span class="storage type rust">i32</span></span></span><span class="punctuation terminator rust">;</span> </span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span></span>

<span class="meta trait rust"><span class="storage type trait rust">trait</span> <span class="entity name trait rust">B</span>: A <span class="meta block rust"><span class="punctuation section block begin rust">{</span> <span class="meta function rust"><span class="meta function rust"><span class="storage type function rust">fn</span> </span><span class="entity name function rust">b</span></span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters begin rust">(</span><span class="keyword operator rust">&amp;</span><span class="variable parameter rust">self</span></span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters end rust">)</span></span></span></span><span class="meta function rust"> <span class="meta function return-type rust"><span class="punctuation separator rust">-&gt;</span> <span class="storage type rust">i32</span></span></span><span class="punctuation terminator rust">;</span> </span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span></span> 

<span class="meta impl rust"><span class="storage type impl rust">impl</span> </span><span class="meta impl rust">A <span class="keyword other rust">for</span></span><span class="meta impl rust"> <span class="entity name impl rust">i32</span> </span><span class="meta impl rust"><span class="meta block rust"><span class="punctuation section block begin rust">{</span>
    <span class="meta function rust"><span class="meta function rust"><span class="storage type function rust">fn</span> </span><span class="entity name function rust">a</span></span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters begin rust">(</span><span class="keyword operator rust">&amp;</span><span class="variable parameter rust">self</span></span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters end rust">)</span></span></span></span><span class="meta function rust"> <span class="meta function return-type rust"><span class="punctuation separator rust">-&gt;</span> <span class="storage type rust">i32</span></span> </span><span class="meta function rust"><span class="meta block rust"><span class="punctuation section block begin rust">{</span> <span class="keyword operator rust">*</span><span class="variable language rust">self</span> </span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span></span>
</span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span></span>

<span class="meta impl rust"><span class="storage type impl rust">impl</span> </span><span class="meta impl rust">B <span class="keyword other rust">for</span></span><span class="meta impl rust"> <span class="entity name impl rust">i32</span> </span><span class="meta impl rust"><span class="meta block rust"><span class="punctuation section block begin rust">{</span>
    <span class="meta function rust"><span class="meta function rust"><span class="storage type function rust">fn</span> </span><span class="entity name function rust">b</span></span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters begin rust">(</span><span class="keyword operator rust">&amp;</span><span class="variable parameter rust">self</span></span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters end rust">)</span></span></span></span><span class="meta function rust"> <span class="meta function return-type rust"><span class="punctuation separator rust">-&gt;</span> <span class="storage type rust">i32</span></span> </span><span class="meta function rust"><span class="meta block rust"><span class="punctuation section block begin rust">{</span> <span class="keyword operator rust">*</span><span class="variable language rust">self</span> <span class="keyword operator rust">*</span> <span class="constant numeric integer decimal rust">2</span> </span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span></span>
</span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span></span>

<span class="storage type rust">let</span> a <span class="keyword operator rust">=</span> <span class="support type rust">Box</span><span class="meta path rust"><span class="punctuation accessor rust">::</span></span>new<span class="meta group rust"><span class="punctuation section group begin rust">(</span><span class="constant numeric integer decimal rust">1_</span><span class="storage type numeric rust">i32</span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span> <span class="keyword operator rust">as</span> <span class="meta generic rust">Box<span class="punctuation definition generic begin rust">&lt;</span>dyn A<span class="punctuation definition generic end rust">&gt;</span></span><span class="punctuation terminator rust">;</span>
<span class="storage type rust">let</span> b <span class="keyword operator rust">=</span> <span class="support type rust">Box</span><span class="meta path rust"><span class="punctuation accessor rust">::</span></span>new<span class="meta group rust"><span class="punctuation section group begin rust">(</span><span class="constant numeric integer decimal rust">1_</span><span class="storage type numeric rust">i32</span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span> <span class="keyword operator rust">as</span> <span class="meta generic rust">Box<span class="punctuation definition generic begin rust">&lt;</span>dyn B<span class="punctuation definition generic end rust">&gt;</span></span><span class="punctuation terminator rust">;</span>
</span></pre>
<p>It would make sense for <code>Box&lt;dyn B&gt;</code> to be a subtype of <code>Box&lt;dyn A&gt;</code>, as <code>A</code> is a super <em>trait</em> of <code>B</code>. It
would make sense for this to apply to our <code>Gc</code> type as well. </p>
<p>Unfortunately, this not supported by stable Rust at the current moment. It is possible that this could change
sometime in the future, perhaps soon, but not at the time of writing this article.</p>
<p>But lifetimes can <em>also</em> appear in dyn traits! Basically, while we wait for our <em>actual</em> use case to stabalize,
we are ensuring a covariant relationship in order to support subtype relationships of the following form:</p>
<p><code>Gc&lt;dyn FnMut(&amp;'a T)&gt;</code> is a subtype of <code>Gc&lt;dyn FnMut(&amp;'b T)&gt;</code> for <code>'a: 'b</code>.</p>
<p>That is largely the reason why were are supporting subtyping. Closures. </p>
<p>It’s also not that difficult; we just need to use a <a href="https://doc.rust-lang.org/std/ptr/struct.NonNull.html"><code>NonNull</code></a> pointer wrapper instead of a raw <code>*mut T</code>, a type which <em>is</em> invariant over <code>T</code>. This is what we’d do anyway, as we don’t <em>want</em> a <code>Gc&lt;T&gt;</code> to contain a pointer that <em>is</em> null.</p>
<p>Now that we have that worked out, we can move onto the second thing we need to express:</p>
<h4>Drop checking</h4>
<p>As specified now as just a <code>NonNull&lt;T&gt;</code> and nothing else, the Rust compiler is forced to assume that any 
<code>Gc&lt;T&gt;</code> will be strictly out-lived by the underlying data. For our data type this not the case. Although a lot of Gcs 
represent references to the data, <em>some</em> Gcs represent the entire lifetime - they represent data itself. Therefore,
dropping a <code>Gc</code> can potentially drop the underlying <code>T</code> value. The Rust compiler <em>needs</em> to know about this in 
order to perform its drop check analysis, or else potentially unsound code can be constructed. </p>
<p>In order to indicate this information, we can use a <a href="https://doc.rust-lang.org/std/marker/struct.PhantomData.html"><code>PhantomData</code></a>, a neat wrapper type that indicates to the compiler that our data type should behave as if it has ownership over
a type <code>T</code>.</p>
<p>With these two data types we can put together our Gc<T>:</p>
<pre class="code"><span class="source rust"><span class="comment line documentation rust"><span class="punctuation definition comment rust">///</span> A Garbage-Collected smart pointer with interior mutability.
</span><span class="meta struct rust"><span class="storage modifier rust">pub</span> <span class="storage type struct rust">struct</span> </span><span class="meta struct rust"><span class="meta generic rust"><span class="entity name struct rust">Gc</span><span class="meta generic rust"><span class="punctuation definition generic begin rust">&lt;</span>T<span class="punctuation definition generic end rust">&gt;</span></span></span></span><span class="meta struct rust"> </span><span class="meta struct rust"><span class="meta block rust"><span class="punctuation section block begin rust">{</span>
    <span class="variable other member rust">ptr</span><span class="punctuation separator rust">:</span> <span class="meta generic rust">NonNull<span class="punctuation definition generic begin rust">&lt;</span><span class="meta generic rust">GcInner<span class="punctuation definition generic begin rust">&lt;</span>T<span class="punctuation definition generic end rust">&gt;</span></span><span class="punctuation definition generic end rust">&gt;</span></span>,
    <span class="variable other member rust">marker</span><span class="punctuation separator rust">:</span> <span class="meta generic rust">PhantomData<span class="punctuation definition generic begin rust">&lt;</span><span class="meta generic rust">GcInner<span class="punctuation definition generic begin rust">&lt;</span>T<span class="punctuation definition generic end rust">&gt;</span></span><span class="punctuation definition generic end rust">&gt;</span></span>,
</span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span></span>

<span class="meta impl rust"><span class="storage type impl rust">impl</span></span><span class="meta impl rust"><span class="meta generic rust"><span class="punctuation definition generic begin rust">&lt;</span>T<span class="punctuation definition generic end rust">&gt;</span></span></span><span class="meta impl rust"> <span class="entity name impl rust">Gc</span><span class="meta generic rust"><span class="punctuation definition generic begin rust">&lt;</span>T<span class="punctuation definition generic end rust">&gt;</span></span> </span><span class="meta impl rust"><span class="meta block rust"><span class="punctuation section block begin rust">{</span>
    <span class="meta function rust"><span class="meta function rust"><span class="storage modifier rust">pub</span> <span class="storage type function rust">fn</span> </span><span class="entity name function rust">new</span></span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters begin rust">(</span><span class="variable parameter rust">data</span><span class="punctuation separator rust">:</span> T</span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters end rust">)</span></span></span></span><span class="meta function rust"> <span class="meta function return-type rust"><span class="punctuation separator rust">-&gt;</span> <span class="meta generic rust">Gc<span class="punctuation definition generic begin rust">&lt;</span>T<span class="punctuation definition generic end rust">&gt;</span></span></span> </span><span class="meta function rust"><span class="meta block rust"><span class="punctuation section block begin rust">{</span>
        <span class="storage type rust">Self</span> <span class="meta block rust"><span class="punctuation section block begin rust">{</span>
            ptr<span class="punctuation separator rust">:</span> <span class="meta path rust">NonNull<span class="punctuation accessor rust">::</span></span>from<span class="meta group rust"><span class="punctuation section group begin rust">(</span><span class="support type rust">Box</span><span class="meta path rust"><span class="punctuation accessor rust">::</span></span>leak<span class="meta group rust"><span class="punctuation section group begin rust">(</span><span class="support type rust">Box</span><span class="meta path rust"><span class="punctuation accessor rust">::</span></span>new<span class="meta group rust"><span class="punctuation section group begin rust">(</span>GcInner <span class="meta block rust"><span class="punctuation section block begin rust">{</span>
                header<span class="punctuation separator rust">:</span> <span class="meta path rust">GcHeader<span class="punctuation accessor rust">::</span></span>default<span class="meta group rust"><span class="punctuation section group begin rust">(</span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span><span class="punctuation separator rust">,</span>
                data<span class="punctuation separator rust">,</span>
            </span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span><span class="punctuation separator rust">,</span>
            marker<span class="punctuation separator rust">:</span> PhantomData<span class="punctuation separator rust">,</span>
        </span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span>
    </span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span></span>
</span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span></span>
</span></pre>
<p>The <code>new</code> code is rather straightforward but worth commenting on. The easiest way to allocate a pointer in 
Rust is to use the <code>Box::new</code> to allocates space and copy our data onto the heap, and then use the <code>Box::leak</code>
function to prevent the Box from freeing the data on its drop, thus leaving us with a dangling pointer that 
we can later deallocate manually. </p>
<h2>Thread-Safe Interior Mutability</h2>
<p>Now that we have data, we need to provide a way to modify that data in a thread-safe manner. The very first
thing we have to tell our compiler that we intend to actually do this. By default, Rust assumes that for the
lifetime an immutable reference is held, the data referenced to will not be modified. We would like to opt 
out of that assumption. To that end, we must use the <a href="https://doc.rust-lang.org/std/cell/struct.UnsafeCell.html"><code>UnsafeCell</code></a> wrapper. </p>
<p>Obviously, we want to make sure that if someone is trying to read the data behind a a Gc that no one is trying
to modify it at the same time. You are never allowed to do unsound things in Rust, you are only allowed to tell
the compiler that it can’t make assumptions about the references that actively exist in your program. </p>
<p>Additionally, we are going to tell Rust that it should trust us to implement these rules in a thread-safe manner.
Our <code>GcInner</code> type now looks like the following:</p>
<pre class="code"><span class="source rust"><span class="meta struct rust"><span class="storage modifier rust">pub</span> <span class="storage type struct rust">struct</span> </span><span class="meta struct rust"><span class="meta generic rust"><span class="entity name struct rust">GcInner</span><span class="meta generic rust"><span class="punctuation definition generic begin rust">&lt;</span>T<span class="punctuation separator rust">:</span> <span class="invalid illegal rust">?</span></span></span></span><span class="meta struct rust">Sized&gt; </span><span class="meta struct rust"><span class="meta block rust"><span class="punctuation section block begin rust">{</span>
    <span class="variable other member rust">header</span><span class="punctuation separator rust">:</span> <span class="meta generic rust">UnsafeCell<span class="punctuation definition generic begin rust">&lt;</span>GcHeader<span class="punctuation definition generic end rust">&gt;</span></span>,
    <span class="variable other member rust">data</span><span class="punctuation separator rust">:</span> <span class="meta generic rust">UnsafeCell<span class="punctuation definition generic begin rust">&lt;</span>T<span class="punctuation definition generic end rust">&gt;</span></span>,
</span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span></span>

<span class="storage modifier rust">unsafe</span> <span class="meta impl rust"><span class="storage type impl rust">impl</span></span><span class="meta impl rust"><span class="meta generic rust"><span class="punctuation definition generic begin rust">&lt;</span>T<span class="punctuation separator rust">:</span> <span class="invalid illegal rust">?</span></span></span><span class="meta impl rust"><span class="entity name impl rust">Sized</span> + <span class="entity name impl rust">Send</span>&gt; <span class="entity name impl rust">Send</span> <span class="entity name impl rust">for</span> <span class="entity name impl rust">GcInner</span><span class="meta generic rust"><span class="punctuation definition generic begin rust">&lt;</span>T<span class="punctuation definition generic end rust">&gt;</span></span> </span><span class="meta impl rust"><span class="meta block rust"><span class="punctuation section block begin rust">{</span></span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span></span>
<span class="storage modifier rust">unsafe</span> <span class="meta impl rust"><span class="storage type impl rust">impl</span></span><span class="meta impl rust"><span class="meta generic rust"><span class="punctuation definition generic begin rust">&lt;</span>T<span class="punctuation separator rust">:</span> <span class="invalid illegal rust">?</span></span></span><span class="meta impl rust"><span class="entity name impl rust">Sized</span> + <span class="entity name impl rust">Sync</span>&gt; <span class="entity name impl rust">Sync</span> <span class="entity name impl rust">for</span> <span class="entity name impl rust">GcInner</span><span class="meta generic rust"><span class="punctuation definition generic begin rust">&lt;</span>T<span class="punctuation definition generic end rust">&gt;</span></span> </span><span class="meta impl rust"><span class="meta block rust"><span class="punctuation section block begin rust">{</span></span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span></span>

<span class="comment line double-slash rust"><span class="punctuation definition comment rust">//</span> (also necessary)
</span><span class="storage modifier rust">unsafe</span> <span class="meta impl rust"><span class="storage type impl rust">impl</span> </span><span class="meta impl rust">Send <span class="keyword other rust">for</span></span><span class="meta impl rust"> <span class="entity name impl rust">GcHeader</span> </span><span class="meta impl rust"><span class="meta block rust"><span class="punctuation section block begin rust">{</span></span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span></span>
<span class="storage modifier rust">unsafe</span> <span class="meta impl rust"><span class="storage type impl rust">impl</span> </span><span class="meta impl rust">Sync <span class="keyword other rust">for</span></span><span class="meta impl rust"> <span class="entity name impl rust">GcHeader</span> </span><span class="meta impl rust"><span class="meta block rust"><span class="punctuation section block begin rust">{</span></span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span></span>
</span></pre>
<p>Now we have to figure out how to allow for interior mutability. Well, we want this type to behave like 
a <code>RwLock&lt;T&gt;</code>, so how are those implemented?</p>
<h3>Semaphores</h3>
<p>A Semaphore is a way to control access to a resource. Essentially, it is an array off N slots that each process
is allowed to claim ownership of. If all N slots are claimed, then processes must queue up and wait for
the processes with ownership to relinquish them.</p>
<pre class="code">Acquire(Semaphore) -> Option<Permit>
Release(Permit) 
</pre>
<p>(both of these operations are atomic)</p>
<p>The ordering of these slots is irrelevant. Processes are only concerned with having ownership of a slot or
not. If the Semaphore has only one slot, you can make this value behave exactly like a typical Mutex:</p>
<pre class="code">Lock(Semaphore) -> Permit:
    loop:
        match Acquire(Semaphore):
            Some(Permit) => return Permit,
</pre>
<p>If we were to change our semaphore have N &gt; 1 slots, we need to add another atomic operation in order to properly
mimic our <code>Mutex</code>:</p>
<pre class="code">AcquireN(Semaphore, NumSlots) -> Option<Permit>`
</pre>
<p>Locking is pretty much the same, but instead of attempting to acquire one slot, we attempt to acquire all N.</p>
<p>But we don’t have to always lock a variable. In fact, I think I see a way we can mimic Rust’s safety rules 
here - we can have an unlimited number of immutable references OR one single mutable reference and never
both. The trick is to have our reads only acquire one slot and our writes acquire all N. </p>
<p>To implement this, we’re going to use <a href="https://docs.rs/tokio/latest/tokio/sync/struct.Semaphore.html">tokio’s Semaphore</a>,
which interfaces well async rust. Let’s add it to <code>GcHeader</code>:</p>
<pre class="code"><span class="source rust"><span class="meta struct rust"><span class="storage type struct rust">struct</span> </span><span class="meta struct rust"><span class="entity name struct rust">GcHeader</span> </span><span class="meta struct rust"><span class="meta block rust"><span class="punctuation section block begin rust">{</span>
    <span class="variable other member rust">semaphore</span><span class="punctuation separator rust">:</span> <span class="meta path rust">tokio<span class="punctuation accessor rust">::</span></span><span class="meta path rust">sync<span class="punctuation accessor rust">::</span></span>Semaphore,
</span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span></span>
</span></pre>
<h3>Read/Write Guards</h3>
<p>We need some types to represent our acquired resource with. In Rust, these are done with Guards. Guards are 
structs that:</p>
<ul>
<li>hold a reference and a permit of use for a resource </li>
<li>are treated transparently as a reference to the resource (via Deref and/or DerefMut)</li>
<li>release the permit when they are dropped</li>
<li>has the lifetime of the wrapper type (so cannot be returned from a function with the wrapper as a local)</li>
</ul>
<pre class="code"><span class="source rust"><span class="meta struct rust"><span class="storage modifier rust">pub</span> <span class="storage type struct rust">struct</span> </span><span class="meta struct rust"><span class="meta generic rust"><span class="entity name struct rust">GcReadGuard</span><span class="meta generic rust"><span class="punctuation definition generic begin rust">&lt;</span><span class="storage modifier lifetime rust">&#39;a</span>, T<span class="punctuation separator rust">:</span> <span class="invalid illegal rust">?</span></span></span></span><span class="meta struct rust">Sized&gt; </span><span class="meta struct rust"><span class="meta block rust"><span class="punctuation section block begin rust">{</span>
    <span class="variable other member rust">_permit</span><span class="punctuation separator rust">:</span> <span class="meta path rust">tokio<span class="punctuation accessor rust">::</span></span><span class="meta path rust">sync<span class="punctuation accessor rust">::</span></span><span class="meta generic rust">SemaphorePermit<span class="punctuation definition generic begin rust">&lt;</span><span class="storage modifier lifetime rust">&#39;a</span><span class="punctuation definition generic end rust">&gt;</span></span>,
    <span class="variable other member rust">data</span><span class="punctuation separator rust">:</span> *const T,
    <span class="variable other member rust">marker</span><span class="punctuation separator rust">:</span> <span class="meta generic rust">PhantomData<span class="punctuation definition generic begin rust">&lt;</span><span class="keyword operator rust">&amp;</span><span class="storage modifier lifetime rust">&#39;a</span> T<span class="punctuation definition generic end rust">&gt;</span></span>,
</span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span></span>

<span class="meta impl rust"><span class="storage type impl rust">impl</span></span><span class="meta impl rust"><span class="meta generic rust"><span class="punctuation definition generic begin rust">&lt;</span>T<span class="punctuation separator rust">:</span> <span class="invalid illegal rust">?</span></span></span><span class="meta impl rust"><span class="entity name impl rust">Sized</span>&gt; <span class="entity name impl rust">Deref</span> <span class="entity name impl rust">for</span> <span class="entity name impl rust">GcReadGuard</span><span class="meta generic rust"><span class="punctuation definition generic begin rust">&lt;</span>&#39;<span class="keyword operator rust">_</span>, T<span class="punctuation definition generic end rust">&gt;</span></span> </span><span class="meta impl rust"><span class="meta block rust"><span class="punctuation section block begin rust">{</span>
    <span class="storage type type rust">type</span> <span class="entity name type rust">Target</span> <span class="keyword operator rust">=</span> T<span class="punctuation terminator rust">;</span>

    <span class="meta function rust"><span class="meta function rust"><span class="storage type function rust">fn</span> </span><span class="entity name function rust">deref</span></span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters begin rust">(</span><span class="keyword operator rust">&amp;</span><span class="variable parameter rust">self</span></span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters end rust">)</span></span></span></span><span class="meta function rust"> <span class="meta function return-type rust"><span class="punctuation separator rust">-&gt;</span> <span class="keyword operator rust">&amp;</span>T</span> </span><span class="meta function rust"><span class="meta block rust"><span class="punctuation section block begin rust">{</span>
        <span class="storage modifier rust">unsafe</span> <span class="meta block rust"><span class="punctuation section block begin rust">{</span> <span class="keyword operator rust">&amp;</span><span class="keyword operator rust">*</span><span class="variable language rust">self</span>.data </span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span>
    </span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span></span>
</span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span></span>

<span class="meta impl rust"><span class="storage type impl rust">impl</span></span><span class="meta impl rust"><span class="meta generic rust"><span class="punctuation definition generic begin rust">&lt;</span>T<span class="punctuation separator rust">:</span> <span class="invalid illegal rust">?</span></span></span><span class="meta impl rust"><span class="entity name impl rust">Sized</span>&gt; <span class="entity name impl rust">AsRef</span><span class="meta generic rust"><span class="punctuation definition generic begin rust">&lt;</span>T<span class="punctuation definition generic end rust">&gt;</span></span> <span class="entity name impl rust">for</span> <span class="entity name impl rust">GcReadGuard</span><span class="meta generic rust"><span class="punctuation definition generic begin rust">&lt;</span>&#39;<span class="keyword operator rust">_</span>, T<span class="punctuation definition generic end rust">&gt;</span></span> </span><span class="meta impl rust"><span class="meta block rust"><span class="punctuation section block begin rust">{</span>
    <span class="meta function rust"><span class="meta function rust"><span class="storage type function rust">fn</span> </span><span class="entity name function rust">as_ref</span></span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters begin rust">(</span><span class="keyword operator rust">&amp;</span><span class="variable parameter rust">self</span></span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters end rust">)</span></span></span></span><span class="meta function rust"> <span class="meta function return-type rust"><span class="punctuation separator rust">-&gt;</span> <span class="keyword operator rust">&amp;</span>T</span> </span><span class="meta function rust"><span class="meta block rust"><span class="punctuation section block begin rust">{</span>
        <span class="variable language rust">self</span>
    </span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span></span>
</span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span></span>

<span class="storage modifier rust">unsafe</span> <span class="meta impl rust"><span class="storage type impl rust">impl</span></span><span class="meta impl rust"><span class="meta generic rust"><span class="punctuation definition generic begin rust">&lt;</span>T<span class="punctuation separator rust">:</span> <span class="invalid illegal rust">?</span></span></span><span class="meta impl rust"><span class="entity name impl rust">Sized</span> + <span class="entity name impl rust">Send</span>&gt; <span class="entity name impl rust">Send</span> <span class="entity name impl rust">for</span> <span class="entity name impl rust">GcReadGuard</span><span class="meta generic rust"><span class="punctuation definition generic begin rust">&lt;</span>&#39;<span class="keyword operator rust">_</span>, T<span class="punctuation definition generic end rust">&gt;</span></span> </span><span class="meta impl rust"><span class="meta block rust"><span class="punctuation section block begin rust">{</span></span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span></span>
<span class="storage modifier rust">unsafe</span> <span class="meta impl rust"><span class="storage type impl rust">impl</span></span><span class="meta impl rust"><span class="meta generic rust"><span class="punctuation definition generic begin rust">&lt;</span>T<span class="punctuation separator rust">:</span> <span class="invalid illegal rust">?</span></span></span><span class="meta impl rust"><span class="entity name impl rust">Sized</span> + <span class="entity name impl rust">Sync</span>&gt; <span class="entity name impl rust">Sync</span> <span class="entity name impl rust">for</span> <span class="entity name impl rust">GcReadGuard</span><span class="meta generic rust"><span class="punctuation definition generic begin rust">&lt;</span>&#39;<span class="keyword operator rust">_</span>, T<span class="punctuation definition generic end rust">&gt;</span></span> </span><span class="meta impl rust"><span class="meta block rust"><span class="punctuation section block begin rust">{</span></span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span></span>

<span class="meta struct rust"><span class="storage modifier rust">pub</span> <span class="storage type struct rust">struct</span> </span><span class="meta struct rust"><span class="meta generic rust"><span class="entity name struct rust">GcWriteGuard</span><span class="meta generic rust"><span class="punctuation definition generic begin rust">&lt;</span><span class="storage modifier lifetime rust">&#39;a</span>, T<span class="punctuation separator rust">:</span> <span class="invalid illegal rust">?</span></span></span></span><span class="meta struct rust">Sized&gt; </span><span class="meta struct rust"><span class="meta block rust"><span class="punctuation section block begin rust">{</span>
    <span class="variable other member rust">_permit</span><span class="punctuation separator rust">:</span> <span class="meta path rust">tokio<span class="punctuation accessor rust">::</span></span><span class="meta path rust">sync<span class="punctuation accessor rust">::</span></span><span class="meta generic rust">SemaphorePermit<span class="punctuation definition generic begin rust">&lt;</span><span class="storage modifier lifetime rust">&#39;a</span><span class="punctuation definition generic end rust">&gt;</span></span>,
    <span class="variable other member rust">data</span><span class="punctuation separator rust">:</span> *<span class="storage modifier rust">mut</span> T,
    <span class="variable other member rust">marker</span><span class="punctuation separator rust">:</span> <span class="meta generic rust">PhantomData<span class="punctuation definition generic begin rust">&lt;</span><span class="keyword operator rust">&amp;</span><span class="storage modifier lifetime rust">&#39;a</span> <span class="storage modifier rust">mut</span> T<span class="punctuation definition generic end rust">&gt;</span></span>,
</span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span></span>

<span class="meta impl rust"><span class="storage type impl rust">impl</span></span><span class="meta impl rust"><span class="meta generic rust"><span class="punctuation definition generic begin rust">&lt;</span>T<span class="punctuation definition generic end rust">&gt;</span></span></span><span class="meta impl rust"> Deref <span class="keyword other rust">for</span></span><span class="meta impl rust"> <span class="entity name impl rust">GcWriteGuard</span><span class="meta generic rust"><span class="punctuation definition generic begin rust">&lt;</span>&#39;<span class="keyword operator rust">_</span>, T<span class="punctuation separator rust">:</span> <span class="invalid illegal rust">?</span></span><span class="entity name impl rust">Sized</span>&gt; </span><span class="meta impl rust"><span class="meta block rust"><span class="punctuation section block begin rust">{</span>
    <span class="storage type type rust">type</span> <span class="entity name type rust">Target</span> <span class="keyword operator rust">=</span> T<span class="punctuation terminator rust">;</span>

    <span class="meta function rust"><span class="meta function rust"><span class="storage type function rust">fn</span> </span><span class="entity name function rust">deref</span></span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters begin rust">(</span><span class="keyword operator rust">&amp;</span><span class="variable parameter rust">self</span></span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters end rust">)</span></span></span></span><span class="meta function rust"> <span class="meta function return-type rust"><span class="punctuation separator rust">-&gt;</span> <span class="keyword operator rust">&amp;</span>T</span> </span><span class="meta function rust"><span class="meta block rust"><span class="punctuation section block begin rust">{</span>
        <span class="storage modifier rust">unsafe</span> <span class="meta block rust"><span class="punctuation section block begin rust">{</span> <span class="keyword operator rust">&amp;</span><span class="keyword operator rust">*</span><span class="variable language rust">self</span>.data </span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span>
    </span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span></span>
</span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span></span>

<span class="meta impl rust"><span class="storage type impl rust">impl</span></span><span class="meta impl rust"><span class="meta generic rust"><span class="punctuation definition generic begin rust">&lt;</span>T<span class="punctuation definition generic end rust">&gt;</span></span></span><span class="meta impl rust"> DerefMut <span class="keyword other rust">for</span></span><span class="meta impl rust"> <span class="entity name impl rust">GcWriteGuard</span><span class="meta generic rust"><span class="punctuation definition generic begin rust">&lt;</span>&#39;<span class="keyword operator rust">_</span>, T<span class="punctuation separator rust">:</span> <span class="invalid illegal rust">?</span></span><span class="entity name impl rust">Sized</span>&gt; </span><span class="meta impl rust"><span class="meta block rust"><span class="punctuation section block begin rust">{</span>
    <span class="meta function rust"><span class="meta function rust"><span class="storage type function rust">fn</span> </span><span class="entity name function rust">deref_mut</span></span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters begin rust">(</span><span class="keyword operator rust">&amp;</span><span class="storage modifier rust">mut</span> <span class="variable parameter rust">self</span></span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters end rust">)</span></span></span></span><span class="meta function rust"> <span class="meta function return-type rust"><span class="punctuation separator rust">-&gt;</span> <span class="keyword operator rust">&amp;</span><span class="storage modifier rust">mut</span> T</span> </span><span class="meta function rust"><span class="meta block rust"><span class="punctuation section block begin rust">{</span>
        <span class="storage modifier rust">unsafe</span> <span class="meta block rust"><span class="punctuation section block begin rust">{</span> <span class="keyword operator rust">&amp;</span><span class="storage modifier rust">mut</span> <span class="keyword operator rust">*</span><span class="variable language rust">self</span>.data </span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span>
    </span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span></span>
</span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span></span>

<span class="storage modifier rust">unsafe</span> <span class="meta impl rust"><span class="storage type impl rust">impl</span></span><span class="meta impl rust"><span class="meta generic rust"><span class="punctuation definition generic begin rust">&lt;</span>T<span class="punctuation separator rust">:</span> <span class="invalid illegal rust">?</span></span></span><span class="meta impl rust"><span class="entity name impl rust">Sized</span> + <span class="entity name impl rust">Send</span>&gt; <span class="entity name impl rust">Send</span> <span class="entity name impl rust">for</span> <span class="entity name impl rust">GcWriteGuard</span><span class="meta generic rust"><span class="punctuation definition generic begin rust">&lt;</span>&#39;<span class="keyword operator rust">_</span>, T<span class="punctuation definition generic end rust">&gt;</span></span> </span><span class="meta impl rust"><span class="meta block rust"><span class="punctuation section block begin rust">{</span></span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span></span>
<span class="storage modifier rust">unsafe</span> <span class="meta impl rust"><span class="storage type impl rust">impl</span></span><span class="meta impl rust"><span class="meta generic rust"><span class="punctuation definition generic begin rust">&lt;</span>T<span class="punctuation separator rust">:</span> <span class="invalid illegal rust">?</span></span></span><span class="meta impl rust"><span class="entity name impl rust">Sized</span> + <span class="entity name impl rust">Sync</span>&gt; <span class="entity name impl rust">Sync</span> <span class="entity name impl rust">for</span> <span class="entity name impl rust">GcWriteGuard</span><span class="meta generic rust"><span class="punctuation definition generic begin rust">&lt;</span>&#39;<span class="keyword operator rust">_</span>, T<span class="punctuation definition generic end rust">&gt;</span></span> </span><span class="meta impl rust"><span class="meta block rust"><span class="punctuation section block begin rust">{</span></span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span></span>
</span></pre>
<p>Again, you will notice that in both of these structs we use the same trick to ensure the desired variance 
(covariance) over each of the guards type parameters.</p>
<p>Since we use the tokio semaphore, we can create futures that await the acquisition of the permit:</p>
<pre class="code"><span class="source rust"><span class="meta impl rust"><span class="storage type impl rust">impl</span></span><span class="meta impl rust"><span class="meta generic rust"><span class="punctuation definition generic begin rust">&lt;</span>T<span class="punctuation definition generic end rust">&gt;</span></span></span><span class="meta impl rust"> <span class="entity name impl rust">Gc</span><span class="meta generic rust"><span class="punctuation definition generic begin rust">&lt;</span>T<span class="punctuation definition generic end rust">&gt;</span></span> </span><span class="meta impl rust"><span class="meta block rust"><span class="punctuation section block begin rust">{</span>
    <span class="comment line documentation rust"><span class="punctuation definition comment rust">///</span> Acquire a read lock for the object
</span>    <span class="storage modifier rust">pub</span> async <span class="meta function rust"><span class="meta function rust"><span class="storage type function rust">fn</span> </span><span class="entity name function rust">read</span></span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters begin rust">(</span><span class="keyword operator rust">&amp;</span><span class="variable parameter rust">self</span></span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters end rust">)</span></span></span></span><span class="meta function rust"> <span class="meta function return-type rust"><span class="punctuation separator rust">-&gt;</span> <span class="meta generic rust">GcReadGuard<span class="punctuation definition generic begin rust">&lt;</span>&#39;<span class="keyword operator rust">_</span>, T<span class="punctuation definition generic end rust">&gt;</span></span></span> </span><span class="meta function rust"><span class="meta block rust"><span class="punctuation section block begin rust">{</span>
        <span class="storage modifier rust">unsafe</span> <span class="meta block rust"><span class="punctuation section block begin rust">{</span>
            <span class="storage type rust">let</span> _permit <span class="keyword operator rust">=</span> <span class="meta group rust"><span class="punctuation section group begin rust">(</span><span class="keyword operator rust">*</span><span class="variable language rust">self</span>.ptr.<span class="support function rust">as_ref</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span>.header.<span class="support function rust">get</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span>
                .semaphore
                .<span class="support function rust">acquire</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span>
                .await
                .<span class="support function rust">unwrap</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span><span class="punctuation terminator rust">;</span>
            <span class="storage type rust">let</span> data <span class="keyword operator rust">=</span> <span class="keyword operator rust">&amp;</span><span class="keyword operator rust">*</span><span class="variable language rust">self</span>.ptr.<span class="support function rust">as_ref</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span>.data.<span class="support function rust">get</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span> <span class="keyword operator rust">as</span> <span class="keyword operator rust">*</span><span class="storage type rust">const</span> T<span class="punctuation terminator rust">;</span>
            GcReadGuard <span class="meta block rust"><span class="punctuation section block begin rust">{</span>
                _permit<span class="punctuation separator rust">,</span>
                data<span class="punctuation separator rust">,</span>
                marker<span class="punctuation separator rust">:</span> PhantomData<span class="punctuation separator rust">,</span>
            </span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span>
        </span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span>
    </span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span></span>

    <span class="comment line documentation rust"><span class="punctuation definition comment rust">///</span> Acquire a write lock for the object
</span>    <span class="storage modifier rust">pub</span> async <span class="meta function rust"><span class="meta function rust"><span class="storage type function rust">fn</span> </span><span class="entity name function rust">write</span></span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters begin rust">(</span><span class="keyword operator rust">&amp;</span><span class="variable parameter rust">self</span></span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters end rust">)</span></span></span></span><span class="meta function rust"> <span class="meta function return-type rust"><span class="punctuation separator rust">-&gt;</span> <span class="meta generic rust">GcWriteGuard<span class="punctuation definition generic begin rust">&lt;</span>&#39;<span class="keyword operator rust">_</span>, T<span class="punctuation definition generic end rust">&gt;</span></span></span> </span><span class="meta function rust"><span class="meta block rust"><span class="punctuation section block begin rust">{</span>
        <span class="storage modifier rust">unsafe</span> <span class="meta block rust"><span class="punctuation section block begin rust">{</span>
            <span class="storage type rust">let</span> _permit <span class="keyword operator rust">=</span> <span class="meta group rust"><span class="punctuation section group begin rust">(</span><span class="keyword operator rust">*</span><span class="variable language rust">self</span>.ptr.<span class="support function rust">as_ref</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span>.header.<span class="support function rust">get</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span>
                .semaphore
                .<span class="support function rust">acquire_many</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span><span class="constant other rust">MAX_READS</span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span>
                .await
                .<span class="support function rust">unwrap</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span><span class="punctuation terminator rust">;</span>
            <span class="storage type rust">let</span> data <span class="keyword operator rust">=</span> <span class="keyword operator rust">&amp;</span><span class="storage modifier rust">mut</span> <span class="keyword operator rust">*</span><span class="variable language rust">self</span>.ptr.<span class="support function rust">as_ref</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span>.data.<span class="support function rust">get</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span> <span class="keyword operator rust">as</span> <span class="keyword operator rust">*</span><span class="storage modifier rust">mut</span> T<span class="punctuation terminator rust">;</span>
            GcWriteGuard <span class="meta block rust"><span class="punctuation section block begin rust">{</span>
                _permit<span class="punctuation separator rust">,</span>
                data<span class="punctuation separator rust">,</span>
                marker<span class="punctuation separator rust">:</span> PhantomData<span class="punctuation separator rust">,</span>
            </span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span>
        </span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span>
    </span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span></span>
</span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span></span>
</span></pre>
<p>Cool! Now we have a heap allocated object with thread-safe interior mutability that lives forever.
Now we need to figure out a way to kill it, that’s the fun part. </p>
<h2>Garbage Collection</h2>
<p>There are two main techniques for determining if allocated objects are garbage; tracing and reference counting.
Besides practical differences in performance and memory overhead, they differ in what information they 
take as input:</p>
<ul>
<li>Tracing algorithms require a set of roots; values that one is required to go through in order to reach heap
objects. These would include stack variables and globals.</li>
<li>Reference counting algorithms require the number of active reference counts to an object.</li>
</ul>
<p>Determining which objects are roots at any given time in Rust is pretty annoying. It’s certainly possible, there
are a few implementations of tracing collectors in Rust (including <a href="https://github.com/Manishearth/rust-gc">rust-gc</a>),
but it doesn’t seem particularly efficient. It involves recursively rooting/unrooting whenever you move an object 
into a new Gc (I think). </p>
<p>Instead, we will use reference counting, because we <em>can</em> pretty easily determine an object’s reference count in 
Rust. In Rust, an object’s reference count is determined by the difference of clones and drops plus one. This is 
because Rust has an <a href="https://en.wikipedia.org/wiki/Substructural_type_system#Affine_type_systems">affine type system</a>
for objects that do not implement <code>Copy</code>, which means that an object that does not implement <code>Copy</code> can be moved 
at <em>most</em> once, which means that moves do not affect the reference count of an object. Now, if we were able to construct
a <code>Gc</code> manually, i.e. by manually instanciating its fields with a copied <a href="https://doc.rust-lang.org/std/ptr/struct.NonNull.html#impl-Copy-for-NonNull%3CT%3E"><code>NonNull</code></a>,
our invariant would not hold. But Gc’s field is private, and thus we can be assured that a <code>Gc</code> can only be created
by user code via the <code>new</code> - which instanciates a new <code>Gc</code> with a ref count of one - or <code>clone</code> functions - which
increment the reference count. Since <code>drop</code> only runs when a variable is <a href="https://en.wikipedia.org/wiki/Safety_and_liveness_properties">no longer live</a>,
we know that it corresponds to a decrement in the ref count. Drop is not <em>guaranteed</em> to be invoked for an object, 
a user could call <a href="https://doc.rust-lang.org/std/mem/fn.forget.html"><code>forget</code></a> with the object and its destructor
will not be run. But practically speaking, the destructor for an object is pretty much always going to be run.</p>
<p>Reference counting does have a pretty key problem: cycles</p>
<h3>Cycles</h3>
<p>(fig1)</p>
<p>An object can be unreachable but still have a positive reference count. This is because our data structures allow for
<em>cycles</em> (see fig1). Such data structures are pretty common to create, especially in functional languages like Scheme.
But even if they <em>weren’t</em>, since they <em>are</em>, a correct to the spec implementation of Scheme <em>must</em> be able to 
recognize such cyclical data structures and garbage collect them when appropriate. To that end, we will be implementing
<a href="https://dl.acm.org/doi/10.5555/646158.680003">Concurrent Cycle Collection in Reference Counted Systems by David F. Bacon and V.T. Rajan</a>,
and algorithm for automatically detecting and collecting cycles in reference counted data structures. </p>
<h3>Synchronous Cycle Collection</h3>
<p>Here is the code listing for the synchronous cycle collection algorithm:</p>
<table style="border: 0px">
  <tr>
    <td>
<pre>
Increment(s)
    RC(S) = RC(S) + 1
    color(S) = black
</pre>
    </td>
    <td>
<pre>
ScanRoots()
    for S in Roots
        Scan(s)
</pre>
    </td>
  </tr>
  <tr>
    <td>
<pre>
Decrement(S) 
    RC(S) = RC(S) - 1
    if (RC(S) == 0) 
        Release(S) 
    else 
        PossibleRoot(S)
</pre>
    </td>
    <td>
<pre>
CollectRoots()
    for S in Roots
        remove S from Roots
        buffered(S) = false
        CollectWhite(S)
</pre>
    </td>
  </tr>
</tr>
  <tr>
    <td>
<pre>
Release(S)
    for T in children(S)
        Decrement(T)
    color(S) = black
    if (! buffered(S))
        Free(S)
</pre>
    </td>
    <td>
<pre>
MarkGray(S)
    if (color(S) != gray)
        color(S) = gray
        for T in children(S)
            Rc(T) = RC(T) - 1
            MarkGray(T)
</pre>
</td>
</tr>
<tr>
    <td>
<pre>
PossibleRoot(S)
    if (color(S) != purple)
        color(S) = purple
        if (! buffered(S))
            buffered(S) = true
            append S to Roots
</pre>
    </td>
    <td>
<pre>
Scan(S)
    if (color(S) == gray)
        if (RC(S) > 0)
            ScanBlack(S)
        else
            color(S) = white
            for T in children(S)
                Scan(T)
</pre>
    </td>
  </tr>
<tr>
    <td>
<pre>
CollectCycles()
    MarkRoots()
    ScanRoots()
    CollectRoots()
</pre>
    </td>
    <td>
<pre>
ScanBlack(S)
    color(S) = black
    for T in children(S)
        RC(T) = TC(T) + 1
        if (color(T) != black)
            ScanBlack(T)
</pre>
    </td>
  </tr>
<tr>
    <td>
<pre>
MarkRoots()
    for S in Roots
        if (color(S) == purple)
            MarkGray(S)
        else
            buffered(S) = false
            remove S from Roots
            if (color(S) == black and RC(S) == 0)
                Free(S)
</pre>
    </td>
    <td>
<pre>
CollectWhite(S)
    if (color(S) == white and !buffered(S))
        color(S) = black
        for T in children(S)
            CollectWhite(T)
        Free(S)
</pre>
</td>
</tr>
</table>
<p>That’s all well and good, but how does this work? Well, I will first say you should read the paper, because it is quite
short and really approachable. But I will briefly explain how it works, leaving out a few key details. </p>
<p>Cycle Collection relies on this key insight: if you were to perform a drop on every Gc in a cycle, that cycle will be 
garbage if the remaining ref count of every node in that cycle is zero. This kind of makes sense intuitively, what we’re 
basically saying here is that if we somehow already knew that a data structure was cyclic, we could just manually sever
an outgoing reference for some random node and the cascade of decrementing reference counts would cleanly free the whole 
data structure. </p>
<p>With this in mind, we can can construct an efficient algorithm to collect cyclical garbage. We’ll color the nodes in 
different colors as they pass through different stages </p>
<ul>
<li><code>Decrement</code>: When we decrement a reference count and the reference count is greater than zero, add it to our list of
possible roots. If we’ve already added it before performing a collection cycle (it’s been marked <em>purple</em>), skip this.</li>
<li><code>Mark</code>: Go through the roots, and perform the test described in the previous paragraph. Practically, this works by 
performing a depth first search on the root, marking each node gray and decrementing the reference count of each child
and repeating the process on them. If the child is already marked gray, we skip them.</li>
<li><code>Scan</code>: Go through the roots and recursively check their children for reference counts greater than zero. If there is
any greater than zero, it recursively marks all of their children black to indicate the data is live. Otherwise, the 
structure is marked white, to indicate it is ready to be freed.</li>
<li><code>Collect</code>: Go through the roots marked white and free them. </li>
</ul>
<p>There is one thing in particular that is not immediately clear about how we are going to fit this into our system. How do 
we iterate over the children? We haven’t put any bounds on the <code>T</code> in our <code>Gc&lt;T&gt;</code> beyond that it has to be <code>'static</code>. Well,
until Rust gains a more powerful reflection story, we are going to have to add a classic Trait plus derive macro combo.</p>
<h3>The Trace trait and derive macros</h3>
<p>Let’s define the trait we need to implement the above code. Basically, we need a function that matches the following form:</p>
<pre class="code">for T in children(S):
    F(T)
</pre>
<p>We can extract two type parameters from this statement: S, and F(T) where T == S. Therefore, the function we want will
have the form <code>fn for_each_children(S, impl FnMut(S))</code>.</p>
<p>It’s not entirely obvious at first glance, but there is another function that we must pay attention to: that is <code>free</code>.
The <code>free</code> function presented in the above code listing does <em>not</em> correspond to how memory is freed in Rust. That is 
because this code assumes that when we free code we are not running any of its members destructors. But we <em>do</em> want to
run our destructors. At least, we want to run the destructor <em>if</em> the type is <em>not</em> a <code>Gc</code>. We’re going to have to add 
a <code>finalize</code> function to handle a custom drop routine:</p>
<pre class="code"><span class="source rust"><span class="storage modifier rust">unsafe</span> <span class="meta trait rust"><span class="storage type trait rust">trait</span> <span class="entity name trait rust">Trace</span>: &#39;static <span class="meta block rust"><span class="punctuation section block begin rust">{</span>
    <span class="storage modifier rust">unsafe</span> <span class="meta function rust"><span class="meta function rust"><span class="storage type function rust">fn</span> </span><span class="entity name function rust">visit_children</span></span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters begin rust">(</span><span class="keyword operator rust">&amp;</span><span class="variable parameter rust">self</span>, <span class="variable parameter rust">visitor</span><span class="punctuation separator rust">:</span> unsafe <span class="storage type function rust">fn</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span></span><span class="meta group rust">OpaqueGcPtr<span class="meta group rust"><span class="punctuation section group end rust">)</span></span></span></span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters end rust">)</span></span></span></span><span class="punctuation terminator rust">;</span>
    
    <span class="storage modifier rust">unsafe</span> <span class="meta function rust"><span class="meta function rust"><span class="storage type function rust">fn</span> </span><span class="entity name function rust">finalize</span></span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters begin rust">(</span><span class="keyword operator rust">&amp;</span><span class="storage modifier rust">mut</span> <span class="variable parameter rust">self</span></span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters end rust">)</span></span></span></span><span class="meta function rust"> </span><span class="meta function rust"><span class="meta block rust"><span class="punctuation section block begin rust">{</span>
        <span class="support function rust">drop_in_place</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span><span class="variable language rust">self</span> <span class="keyword operator rust">as</span> <span class="keyword operator rust">*</span><span class="storage modifier rust">mut</span> <span class="storage type rust">Self</span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span><span class="punctuation terminator rust">;</span>
    </span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span></span>
</span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span></span>
</span></pre>
<p>These two things are in fact the <em>only</em>  two things our collection algorithm cares about in regards to the Gc’s data 
pointer. Therefore, whenever we’re in the context of the collection algorithm, we will cast our Gc’s into a trait object:</p>
<pre class="code"><span class="source rust"><span class="storage type type rust">type</span> <span class="entity name type rust">OpaqueGc</span> <span class="keyword operator rust">=</span> <span class="meta generic rust">GcInner<span class="punctuation definition generic begin rust">&lt;</span>dyn Trace<span class="punctuation definition generic end rust">&gt;</span></span><span class="punctuation terminator rust">;</span>
<span class="storage modifier rust">pub</span> <span class="storage type type rust">type</span> <span class="entity name type rust">OpaqueGcPtr</span> <span class="keyword operator rust">=</span> <span class="meta generic rust">NonNull<span class="punctuation definition generic begin rust">&lt;</span>OpaqueGc<span class="punctuation definition generic end rust">&gt;</span></span><span class="punctuation terminator rust">;</span>

<span class="meta impl rust"><span class="storage type impl rust">impl</span></span><span class="meta impl rust"><span class="meta generic rust"><span class="punctuation definition generic begin rust">&lt;</span>T<span class="punctuation separator rust">:</span> Trace<span class="punctuation definition generic end rust">&gt;</span></span></span><span class="meta impl rust"> <span class="entity name impl rust">Gc</span><span class="meta generic rust"><span class="punctuation definition generic begin rust">&lt;</span>T<span class="punctuation definition generic end rust">&gt;</span></span> </span><span class="meta impl rust"><span class="meta block rust"><span class="punctuation section block begin rust">{</span>
    <span class="storage modifier rust">pub</span> <span class="storage modifier rust">unsafe</span> <span class="meta function rust"><span class="meta function rust"><span class="storage type function rust">fn</span> </span><span class="entity name function rust">as_opaque</span></span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters begin rust">(</span><span class="keyword operator rust">&amp;</span><span class="variable parameter rust">self</span></span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters end rust">)</span></span></span></span><span class="meta function rust"> <span class="meta function return-type rust"><span class="punctuation separator rust">-&gt;</span> OpaqueGcPtr</span> </span><span class="meta function rust"><span class="meta block rust"><span class="punctuation section block begin rust">{</span>
        <span class="variable language rust">self</span>.ptr <span class="keyword operator rust">as</span> OpaqueGcPtr
    </span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span></span>
</span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span></span>
</span></pre>
<p>Now that we have our Trace trait, we can implement it for some primitive types, such as those provided by the standard
library (or really, whatever we’re using to build our data). I won’t provide all of the ones I implemented, but here 
are a few:</p>
<pre class="code"><span class="source rust"><span class="storage modifier rust">unsafe</span> <span class="meta trait rust"><span class="storage type trait rust">trait</span> <span class="entity name trait rust">GcOrTrace</span>: &#39;static <span class="meta block rust"><span class="punctuation section block begin rust">{</span>
    <span class="storage modifier rust">unsafe</span> <span class="meta function rust"><span class="meta function rust"><span class="storage type function rust">fn</span> </span><span class="entity name function rust">visit_or_recurse</span></span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters begin rust">(</span><span class="keyword operator rust">&amp;</span><span class="variable parameter rust">self</span>, <span class="variable parameter rust">visitor</span><span class="punctuation separator rust">:</span> unsafe <span class="storage type function rust">fn</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span></span><span class="meta group rust">OpaqueGcPtr<span class="meta group rust"><span class="punctuation section group end rust">)</span></span></span></span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters end rust">)</span></span></span></span><span class="punctuation terminator rust">;</span>

    <span class="storage modifier rust">unsafe</span> <span class="meta function rust"><span class="meta function rust"><span class="storage type function rust">fn</span> </span><span class="entity name function rust">finalize_or_skip</span></span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters begin rust">(</span><span class="keyword operator rust">&amp;</span><span class="storage modifier rust">mut</span> <span class="variable parameter rust">self</span></span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters end rust">)</span></span></span></span><span class="punctuation terminator rust">;</span>
</span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span></span>

<span class="storage modifier rust">unsafe</span> <span class="meta impl rust"><span class="storage type impl rust">impl</span></span><span class="meta impl rust"><span class="meta generic rust"><span class="punctuation definition generic begin rust">&lt;</span>T<span class="punctuation separator rust">:</span> Trace<span class="punctuation definition generic end rust">&gt;</span></span></span><span class="meta impl rust"> GcOrTrace <span class="keyword other rust">for</span></span><span class="meta impl rust"> <span class="entity name impl rust">Gc</span><span class="meta generic rust"><span class="punctuation definition generic begin rust">&lt;</span>T<span class="punctuation definition generic end rust">&gt;</span></span> </span><span class="meta impl rust"><span class="meta block rust"><span class="punctuation section block begin rust">{</span>
    <span class="storage modifier rust">unsafe</span> <span class="meta function rust"><span class="meta function rust"><span class="storage type function rust">fn</span> </span><span class="entity name function rust">visit_or_recurse</span></span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters begin rust">(</span><span class="keyword operator rust">&amp;</span><span class="variable parameter rust">self</span>, <span class="variable parameter rust">visitor</span><span class="punctuation separator rust">:</span> unsafe <span class="storage type function rust">fn</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span></span><span class="meta group rust">OpaqueGcPtr<span class="meta group rust"><span class="punctuation section group end rust">)</span></span></span></span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters end rust">)</span></span></span></span><span class="meta function rust"> </span><span class="meta function rust"><span class="meta block rust"><span class="punctuation section block begin rust">{</span>
        <span class="support function rust">visitor</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span><span class="variable language rust">self</span>.<span class="support function rust">as_opaque</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span>
    </span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span></span>

    <span class="storage modifier rust">unsafe</span> <span class="meta function rust"><span class="meta function rust"><span class="storage type function rust">fn</span> </span><span class="entity name function rust">finalize_or_skip</span></span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters begin rust">(</span><span class="keyword operator rust">&amp;</span><span class="storage modifier rust">mut</span> <span class="variable parameter rust">self</span></span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters end rust">)</span></span></span></span><span class="meta function rust"> </span><span class="meta function rust"><span class="meta block rust"><span class="punctuation section block begin rust">{</span></span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span></span>
</span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span></span>

<span class="storage modifier rust">unsafe</span> <span class="meta impl rust"><span class="storage type impl rust">impl</span></span><span class="meta impl rust"><span class="meta generic rust"><span class="punctuation definition generic begin rust">&lt;</span>T<span class="punctuation separator rust">:</span> Trace <span class="keyword operator rust">+</span> <span class="invalid illegal rust">?</span></span></span><span class="meta impl rust"><span class="entity name impl rust">Sized</span>&gt; <span class="entity name impl rust">GcOrTrace</span> <span class="entity name impl rust">for</span> <span class="entity name impl rust">T</span> </span><span class="meta impl rust"><span class="meta block rust"><span class="punctuation section block begin rust">{</span>
    <span class="storage modifier rust">unsafe</span> <span class="meta function rust"><span class="meta function rust"><span class="storage type function rust">fn</span> </span><span class="entity name function rust">visit_or_recurse</span></span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters begin rust">(</span><span class="keyword operator rust">&amp;</span><span class="variable parameter rust">self</span>, <span class="variable parameter rust">visitor</span><span class="punctuation separator rust">:</span> unsafe <span class="storage type function rust">fn</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span></span><span class="meta group rust">OpaqueGcPtr<span class="meta group rust"><span class="punctuation section group end rust">)</span></span></span></span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters end rust">)</span></span></span></span><span class="meta function rust"> </span><span class="meta function rust"><span class="meta block rust"><span class="punctuation section block begin rust">{</span>
        <span class="variable language rust">self</span>.<span class="support function rust">visit_children</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span>visitor</span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span><span class="punctuation terminator rust">;</span>
    </span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span></span>

    <span class="storage modifier rust">unsafe</span> <span class="meta function rust"><span class="meta function rust"><span class="storage type function rust">fn</span> </span><span class="entity name function rust">finalize_or_skip</span></span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters begin rust">(</span><span class="keyword operator rust">&amp;</span><span class="storage modifier rust">mut</span> <span class="variable parameter rust">self</span></span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters end rust">)</span></span></span></span><span class="meta function rust"> </span><span class="meta function rust"><span class="meta block rust"><span class="punctuation section block begin rust">{</span>
        <span class="variable language rust">self</span>.<span class="support function rust">finalize</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span><span class="punctuation terminator rust">;</span>
    </span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span></span>
</span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span></span>

<span class="storage modifier rust">unsafe</span> <span class="meta impl rust"><span class="storage type impl rust">impl</span></span><span class="meta impl rust"><span class="meta generic rust"><span class="punctuation definition generic begin rust">&lt;</span>T<span class="punctuation definition generic end rust">&gt;</span></span></span><span class="meta impl rust"> Trace <span class="keyword other rust">for</span></span><span class="meta impl rust"> <span class="entity name impl rust">Vec</span><span class="meta generic rust"><span class="punctuation definition generic begin rust">&lt;</span>T<span class="punctuation definition generic end rust">&gt;</span></span>
</span><span class="meta impl rust"><span class="keyword other rust">where</span>
    T<span class="punctuation separator rust">:</span> GcOrTrace,
</span><span class="meta impl rust"><span class="meta block rust"><span class="punctuation section block begin rust">{</span>
    <span class="storage modifier rust">unsafe</span> <span class="meta function rust"><span class="meta function rust"><span class="storage type function rust">fn</span> </span><span class="entity name function rust">visit_children</span></span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters begin rust">(</span><span class="keyword operator rust">&amp;</span><span class="variable parameter rust">self</span>, <span class="variable parameter rust">visitor</span><span class="punctuation separator rust">:</span> unsafe <span class="storage type function rust">fn</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span></span><span class="meta group rust">OpaqueGcPtr<span class="meta group rust"><span class="punctuation section group end rust">)</span></span></span></span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters end rust">)</span></span></span></span><span class="meta function rust"> </span><span class="meta function rust"><span class="meta block rust"><span class="punctuation section block begin rust">{</span>
        <span class="keyword control rust">for</span> child <span class="keyword operator rust">in</span> <span class="variable language rust">self</span> <span class="meta block rust"><span class="punctuation section block begin rust">{</span>
            child.<span class="support function rust">visit_or_recurse</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span>visitor</span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span><span class="punctuation terminator rust">;</span>
        </span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span>
    </span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span></span>

    <span class="storage modifier rust">unsafe</span> <span class="meta function rust"><span class="meta function rust"><span class="storage type function rust">fn</span> </span><span class="entity name function rust">finalize</span></span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters begin rust">(</span><span class="keyword operator rust">&amp;</span><span class="storage modifier rust">mut</span> <span class="variable parameter rust">self</span></span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters end rust">)</span></span></span></span><span class="meta function rust"> </span><span class="meta function rust"><span class="meta block rust"><span class="punctuation section block begin rust">{</span>
        <span class="keyword control rust">for</span> <span class="storage modifier rust">mut</span> child <span class="keyword operator rust">in</span> <span class="meta path rust">std<span class="punctuation accessor rust">::</span></span><span class="meta path rust">mem<span class="punctuation accessor rust">::</span></span>take<span class="meta group rust"><span class="punctuation section group begin rust">(</span><span class="variable language rust">self</span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span>.<span class="support function rust">into_iter</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span> <span class="meta block rust"><span class="punctuation section block begin rust">{</span>
            child.<span class="support function rust">finalize_or_skip</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span><span class="punctuation terminator rust">;</span>
            <span class="meta path rust">std<span class="punctuation accessor rust">::</span></span><span class="meta path rust">mem<span class="punctuation accessor rust">::</span></span>forget<span class="meta group rust"><span class="punctuation section group begin rust">(</span>child</span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span><span class="punctuation terminator rust">;</span>
        </span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span>
    </span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span></span>
</span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span></span>

<span class="storage modifier rust">unsafe</span> <span class="meta impl rust"><span class="storage type impl rust">impl</span></span><span class="meta impl rust"><span class="meta generic rust"><span class="punctuation definition generic begin rust">&lt;</span>T<span class="punctuation definition generic end rust">&gt;</span></span></span><span class="meta impl rust"> Trace <span class="keyword other rust">for</span></span><span class="meta impl rust"> <span class="entity name impl rust">Option</span><span class="meta generic rust"><span class="punctuation definition generic begin rust">&lt;</span>T<span class="punctuation definition generic end rust">&gt;</span></span>
</span><span class="meta impl rust"><span class="keyword other rust">where</span>
    T<span class="punctuation separator rust">:</span> GcOrTrace,
</span><span class="meta impl rust"><span class="meta block rust"><span class="punctuation section block begin rust">{</span>
    <span class="storage modifier rust">unsafe</span> <span class="meta function rust"><span class="meta function rust"><span class="storage type function rust">fn</span> </span><span class="entity name function rust">visit_children</span></span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters begin rust">(</span><span class="keyword operator rust">&amp;</span><span class="variable parameter rust">self</span>, <span class="variable parameter rust">visitor</span><span class="punctuation separator rust">:</span> unsafe <span class="storage type function rust">fn</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span></span><span class="meta group rust">OpaqueGcPtr<span class="meta group rust"><span class="punctuation section group end rust">)</span></span></span></span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters end rust">)</span></span></span></span><span class="meta function rust"> </span><span class="meta function rust"><span class="meta block rust"><span class="punctuation section block begin rust">{</span>
        <span class="keyword control rust">if</span> <span class="storage type rust">let</span> <span class="support type rust">Some</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span>inner</span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span> <span class="keyword operator rust">=</span> <span class="variable language rust">self</span> <span class="meta block rust"><span class="punctuation section block begin rust">{</span>
            inner.<span class="support function rust">visit_or_recurse</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span>visitor</span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span><span class="punctuation terminator rust">;</span>
        </span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span>
    </span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span></span>

    <span class="storage modifier rust">unsafe</span> <span class="meta function rust"><span class="meta function rust"><span class="storage type function rust">fn</span> </span><span class="entity name function rust">finalize</span></span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters begin rust">(</span><span class="keyword operator rust">&amp;</span><span class="storage modifier rust">mut</span> <span class="variable parameter rust">self</span></span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters end rust">)</span></span></span></span><span class="meta function rust"> </span><span class="meta function rust"><span class="meta block rust"><span class="punctuation section block begin rust">{</span>
        <span class="keyword control rust">if</span> <span class="storage type rust">let</span> <span class="support type rust">Some</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span>inner</span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span> <span class="keyword operator rust">=</span> <span class="variable language rust">self</span> <span class="meta block rust"><span class="punctuation section block begin rust">{</span>
            inner.<span class="support function rust">finalize_or_skip</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span><span class="punctuation terminator rust">;</span>
        </span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span>
    </span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span></span>
</span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span></span>

<span class="storage modifier rust">unsafe</span> <span class="meta impl rust"><span class="storage type impl rust">impl</span></span><span class="meta impl rust"><span class="meta generic rust"><span class="punctuation definition generic begin rust">&lt;</span>T<span class="punctuation definition generic end rust">&gt;</span></span></span><span class="meta impl rust"> Trace <span class="keyword other rust">for</span></span><span class="meta impl rust"> <span class="entity name impl rust">std</span>::<span class="entity name impl rust">sync</span>::<span class="entity name impl rust">Arc</span><span class="meta generic rust"><span class="punctuation definition generic begin rust">&lt;</span>T<span class="punctuation definition generic end rust">&gt;</span></span>
</span><span class="meta impl rust"><span class="keyword other rust">where</span>
    T<span class="punctuation separator rust">:</span> GcOrTrace,
</span><span class="meta impl rust"><span class="meta block rust"><span class="punctuation section block begin rust">{</span>
    <span class="storage modifier rust">unsafe</span> <span class="meta function rust"><span class="meta function rust"><span class="storage type function rust">fn</span> </span><span class="entity name function rust">visit_children</span></span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters begin rust">(</span><span class="keyword operator rust">&amp;</span><span class="variable parameter rust">self</span>, <span class="variable parameter rust">visitor</span><span class="punctuation separator rust">:</span> unsafe <span class="storage type function rust">fn</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span></span><span class="meta group rust">OpaqueGcPtr<span class="meta group rust"><span class="punctuation section group end rust">)</span></span></span></span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters end rust">)</span></span></span></span><span class="meta function rust"> </span><span class="meta function rust"><span class="meta block rust"><span class="punctuation section block begin rust">{</span>
         <span class="variable language rust">self</span>.<span class="support function rust">as_ref</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span>.<span class="support function rust">visit_or_recurse</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span>visitor</span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span><span class="punctuation terminator rust">;</span>
    </span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span></span>
</span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span></span>
</span></pre>
<p>If you are able to immediately spot the error in the code above, you are much smarter than
I am. I hope you at least have the courtesy to be less good looking. Anyway, this code isn’t
correct with our current set of assumptions. And that’s because of the implementation for
Arc, which recurses into its data. </p>
<p>The problem is that we are basically disregarding the reference count of the <code>Arc</code>. consideer the
following situation:</p>
<p>(figure 3)</p>
<p>In this case, dropping A results in our immediately dropping of C. Essentially, the <code>Arc</code> collapses
all of the incoming references to C into one. </p>
<p>This is incorrect, it is probably fixable with lots more code and trait functions, but for now
I’m just going to say “<code>Arcs</code> are <em>still</em> required to address their own cycles with <code>Weak</code>s”. 
I’m not giving them <em>less</em> functionality, just not <em>more</em>.</p>
<p>Here is the correct code for <code>Arc</code>. Part of what makes this code correct is that we added an 
explanation, so make sure to always do that. </p>
<pre class="code"><span class="source rust"><span class="storage modifier rust">unsafe</span> <span class="meta impl rust"><span class="storage type impl rust">impl</span></span><span class="meta impl rust"><span class="meta generic rust"><span class="punctuation definition generic begin rust">&lt;</span>T<span class="punctuation definition generic end rust">&gt;</span></span></span><span class="meta impl rust"> Trace <span class="keyword other rust">for</span></span><span class="meta impl rust"> <span class="entity name impl rust">std</span>::<span class="entity name impl rust">sync</span>::<span class="entity name impl rust">Arc</span><span class="meta generic rust"><span class="punctuation definition generic begin rust">&lt;</span>T<span class="punctuation definition generic end rust">&gt;</span></span>
</span><span class="meta impl rust"><span class="keyword other rust">where</span>
    T<span class="punctuation separator rust">:</span> ?Sized + <span class="storage modifier lifetime rust">&#39;static</span>,
</span><span class="meta impl rust"><span class="meta block rust"><span class="punctuation section block begin rust">{</span>
    <span class="storage modifier rust">unsafe</span> <span class="meta function rust"><span class="meta function rust"><span class="storage type function rust">fn</span> </span><span class="entity name function rust">visit_children</span></span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters begin rust">(</span><span class="keyword operator rust">&amp;</span><span class="variable parameter rust">self</span>, <span class="variable parameter rust">_visitor</span><span class="punctuation separator rust">:</span> unsafe <span class="storage type function rust">fn</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span></span><span class="meta group rust">OpaqueGcPtr<span class="meta group rust"><span class="punctuation section group end rust">)</span></span></span></span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters end rust">)</span></span></span></span><span class="meta function rust"> </span><span class="meta function rust"><span class="meta block rust"><span class="punctuation section block begin rust">{</span>
        <span class="comment line double-slash rust"><span class="punctuation definition comment rust">//</span> We cannot visit the children for an Arc, as it may lead to situations
</span>        <span class="comment line double-slash rust"><span class="punctuation definition comment rust">//</span> were we incorrectly decrement a child twice.
</span>        <span class="comment line double-slash rust"><span class="punctuation definition comment rust">//</span> An Arc wrapping a Gc effectively creates an additional ref count for
</span>        <span class="comment line double-slash rust"><span class="punctuation definition comment rust">//</span> that Gc that we cannot access.
</span>    </span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span></span>
</span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span></span>
</span></pre>
<p>I am not going to get too into the Trait derive proc macro, it’s not particularly interesting. But it’s
important to note what it is actually doing for a given type <code>T</code>:</p>
<ul>
<li><code>visit_children</code>: for every field, if the type is a <code>Gc</code>, call <code>visitor</code> on <code>.opaque_gc</code>. If the type
is <em>not</em> a <code>Gc</code>, recursively call <code>visit_children</code> on it. </li>
<li><code>finalize</code>: for every field, if the type is <em>not</em> a <code>Gc</code>, call <code>finalize</code> on it. </li>
</ul>
<p>If you would like to see how it was done, the code is available <a href="https://github.com/maplant/scheme-rs/blob/main/proc-macros/src/lib.rs">here</a>.</p>
<h3>Deallocation</h3>
<p>The <code>free</code> function needs to call <a href="https://doc.rust-lang.org/std/alloc/fn.dealloc.html"><code>std::alloc::dealloc</code></a> to 
<code>free</code> the allocated memory. This function takes a <a href="https://doc.rust-lang.org/std/alloc/struct.Layout.html">Layout</a>,
how do we find this for our opaque <code>dyn Trace</code> pointer? Turns out the memory and alignment of the underlying data 
is part of Rust’s vtable. So, we can just call <code>Layout::for_value</code> on our reference and create one. Here’s the resulting
free function:</p>
<pre class="code"><span class="source rust"><span class="storage modifier rust">unsafe</span> <span class="meta function rust"><span class="meta function rust"><span class="storage type function rust">fn</span> </span><span class="entity name function rust">trace</span></span><span class="meta generic rust"><span class="punctuation definition generic begin rust">&lt;</span><span class="storage modifier lifetime rust">&#39;a</span><span class="punctuation definition generic end rust">&gt;</span></span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters begin rust">(</span><span class="variable parameter rust">s</span><span class="punctuation separator rust">:</span> OpaqueGcPtr</span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters end rust">)</span></span></span></span><span class="meta function rust"> <span class="meta function return-type rust"><span class="punctuation separator rust">-&gt;</span> <span class="keyword operator rust">&amp;</span><span class="storage modifier lifetime rust">&#39;a</span> <span class="storage modifier rust">mut</span> dyn Trace</span> </span><span class="meta function rust"><span class="meta block rust"><span class="punctuation section block begin rust">{</span>
    <span class="keyword operator rust">&amp;</span><span class="storage modifier rust">mut</span> <span class="keyword operator rust">*</span>s.<span class="support function rust">as_ref</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span>.data.<span class="support function rust">get</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span>
</span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span></span>

<span class="storage modifier rust">unsafe</span> <span class="meta function rust"><span class="meta function rust"><span class="storage type function rust">fn</span> </span><span class="entity name function rust">free</span></span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters begin rust">(</span><span class="variable parameter rust">s</span><span class="punctuation separator rust">:</span> OpaqueGcPtr</span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters end rust">)</span></span></span></span><span class="meta function rust"> </span><span class="meta function rust"><span class="meta block rust"><span class="punctuation section block begin rust">{</span>
    <span class="comment line double-slash rust"><span class="punctuation definition comment rust">//</span> Safety: No need to acquire a permit, s is guaranteed to be garbage.
</span>    <span class="storage type rust">let</span> trace <span class="keyword operator rust">=</span> <span class="support function rust">trace</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span>s</span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span><span class="punctuation terminator rust">;</span>
    <span class="storage type rust">let</span> layout <span class="keyword operator rust">=</span> <span class="meta path rust">Layout<span class="punctuation accessor rust">::</span></span>for_value<span class="meta group rust"><span class="punctuation section group begin rust">(</span>trace</span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span><span class="punctuation terminator rust">;</span>
    trace.<span class="support function rust">finalize</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span><span class="punctuation terminator rust">;</span>
    <span class="meta path rust">std<span class="punctuation accessor rust">::</span></span><span class="meta path rust">alloc<span class="punctuation accessor rust">::</span></span>dealloc<span class="meta group rust"><span class="punctuation section group begin rust">(</span>s.<span class="support function rust">as_ptr</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span> <span class="keyword operator rust">as</span> <span class="keyword operator rust">*</span><span class="storage modifier rust">mut</span> <span class="storage type rust">u8</span><span class="punctuation separator rust">,</span> layout</span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span><span class="punctuation terminator rust">;</span>
</span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span></span>
</span></pre>
<h3>Concurrent Cycle Collection</h3>
<p>We have all the pieces to implement the synchronous cycle collection algorithm, so we’re going to move 
right along into implementing concurrent cycle collection. It’s a very similar algorithms, and I’ll address
the differences as they come along.</p>
<p>Firstly, let’s fix our <code>GcHeader</code> to have all the information it needs:</p>
<pre class="code"><span class="source rust"><span class="meta struct rust"><span class="storage modifier rust">pub</span> <span class="storage type struct rust">struct</span> </span><span class="meta struct rust"><span class="entity name struct rust">GcHeader</span> </span><span class="meta struct rust"><span class="meta block rust"><span class="punctuation section block begin rust">{</span>
    <span class="variable other member rust">rc</span><span class="punctuation separator rust">:</span> <span class="storage type rust">usize</span>,
    <span class="variable other member rust">crc</span><span class="punctuation separator rust">:</span> <span class="storage type rust">usize</span>,
    <span class="variable other member rust">color</span><span class="punctuation separator rust">:</span> Color,
    <span class="variable other member rust">buffered</span><span class="punctuation separator rust">:</span> <span class="storage type rust">bool</span>,
    <span class="variable other member rust">semaphore</span><span class="punctuation separator rust">:</span> Semaphore,
</span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span></span>

<span class="meta enum rust"><span class="storage type enum rust">enum</span> <span class="entity name enum rust">Color</span> <span class="meta block rust"><span class="punctuation section block begin rust">{</span>
    <span class="comment line documentation rust"><span class="punctuation definition comment rust">///</span> In use or free
</span>    Black<span class="punctuation separator rust">,</span>
    <span class="comment line documentation rust"><span class="punctuation definition comment rust">///</span> Possible member of a cycle
</span>    Gray<span class="punctuation separator rust">,</span>
    <span class="comment line documentation rust"><span class="punctuation definition comment rust">///</span> Member of a garbage cycle
</span>    White<span class="punctuation separator rust">,</span>
    <span class="comment line documentation rust"><span class="punctuation definition comment rust">///</span> Possible root of cycle
</span>    Purple<span class="punctuation separator rust">,</span>
    <span class="comment line documentation rust"><span class="punctuation definition comment rust">///</span> Candidate cycle undergoing Σ-computation
</span>    Red<span class="punctuation separator rust">,</span>
    <span class="comment line documentation rust"><span class="punctuation definition comment rust">///</span> Candidate cycle awaiting epoch boundary
</span>    Orange<span class="punctuation separator rust">,</span>
</span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span></span>
</span></pre>
<p>You will notice that the ref counts for our <code>Gc</code> type are <em>not</em> atomic. This is because our concurrent 
algorithm requires a constraint: only one thread at a time can <em>ever</em> modify the ref count, or indeed
<em>any</em> field in the <code>GcHeader</code>. This gives our garbage collection process exclusive read and write 
access to the header. </p>
<p>What gives? How does <em>that</em> work? Isn’t this algorithm supposed to be concurrent? We don’t want
decrementing or incrementing ref counts to wait on the completion of the GC process. That would make
our drop and clone functions blocking, which would gum up our whole system.</p>
<p>The solution is the mutation buffer, and unbounded channel that let’s us buffer incremements and 
decrements to be handled by our collection process as it pleases.</p>
<p>This wil allow our collector to stop processing incremements and decrements at any time and effectively
have a snapshot of the system without causing any pauses in other threads. Since the buffer is <em>unbounded</em>,
calling <code>send</code> is a non-blocking, sync operation:</p>
<pre class="code"><span class="source rust"><span class="meta annotation rust"><span class="punctuation definition annotation rust">#</span><span class="punctuation section group begin rust">[</span><span class="variable annotation rust">derive</span><span class="meta annotation parameters rust"><span class="meta group rust"><span class="punctuation section group begin rust">(</span></span></span><span class="meta annotation parameters rust"><span class="meta group rust">Copy<span class="punctuation separator rust">,</span> Clone</span></span><span class="meta annotation parameters rust"><span class="meta group rust"><span class="punctuation section group end rust">)</span></span></span><span class="punctuation section group end rust">]</span></span>
<span class="meta struct rust"><span class="storage type struct rust">struct</span> </span><span class="meta struct rust"><span class="entity name struct rust">Mutation</span> </span><span class="meta struct rust"><span class="meta block rust"><span class="punctuation section block begin rust">{</span>
    <span class="variable other member rust">kind</span><span class="punctuation separator rust">:</span> MutationKind,
    <span class="variable other member rust">gc</span><span class="punctuation separator rust">:</span> <span class="meta generic rust">NonNull<span class="punctuation definition generic begin rust">&lt;</span>OpaqueGc<span class="punctuation definition generic end rust">&gt;</span></span>,
</span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span></span>

<span class="meta impl rust"><span class="storage type impl rust">impl</span> </span><span class="meta impl rust"><span class="entity name impl rust">Mutation</span> </span><span class="meta impl rust"><span class="meta block rust"><span class="punctuation section block begin rust">{</span>
    <span class="meta function rust"><span class="meta function rust"><span class="storage type function rust">fn</span> </span><span class="entity name function rust">new</span></span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters begin rust">(</span><span class="variable parameter rust">kind</span><span class="punctuation separator rust">:</span> MutationKind, <span class="variable parameter rust">gc</span><span class="punctuation separator rust">:</span> <span class="meta generic rust">NonNull<span class="punctuation definition generic begin rust">&lt;</span>OpaqueGc<span class="punctuation definition generic end rust">&gt;</span></span></span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters end rust">)</span></span></span></span><span class="meta function rust"> <span class="meta function return-type rust"><span class="punctuation separator rust">-&gt;</span> <span class="storage type rust">Self</span></span> </span><span class="meta function rust"><span class="meta block rust"><span class="punctuation section block begin rust">{</span>
        <span class="storage type rust">Self</span> <span class="meta block rust"><span class="punctuation section block begin rust">{</span> kind<span class="punctuation separator rust">,</span> gc </span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span>
    </span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span></span>
</span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span></span>

<span class="storage modifier rust">unsafe</span> <span class="meta impl rust"><span class="storage type impl rust">impl</span> </span><span class="meta impl rust">Send <span class="keyword other rust">for</span></span><span class="meta impl rust"> <span class="entity name impl rust">Mutation</span> </span><span class="meta impl rust"><span class="meta block rust"><span class="punctuation section block begin rust">{</span></span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span></span>
<span class="storage modifier rust">unsafe</span> <span class="meta impl rust"><span class="storage type impl rust">impl</span> </span><span class="meta impl rust">Sync <span class="keyword other rust">for</span></span><span class="meta impl rust"> <span class="entity name impl rust">Mutation</span> </span><span class="meta impl rust"><span class="meta block rust"><span class="punctuation section block begin rust">{</span></span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span></span>

<span class="meta annotation rust"><span class="punctuation definition annotation rust">#</span><span class="punctuation section group begin rust">[</span><span class="variable annotation rust">derive</span><span class="meta annotation parameters rust"><span class="meta group rust"><span class="punctuation section group begin rust">(</span></span></span><span class="meta annotation parameters rust"><span class="meta group rust">Copy<span class="punctuation separator rust">,</span> Clone</span></span><span class="meta annotation parameters rust"><span class="meta group rust"><span class="punctuation section group end rust">)</span></span></span><span class="punctuation section group end rust">]</span></span>
<span class="meta enum rust"><span class="storage type enum rust">enum</span> <span class="entity name enum rust">MutationKind</span> <span class="meta block rust"><span class="punctuation section block begin rust">{</span>
    Inc<span class="punctuation separator rust">,</span>
    Dec<span class="punctuation separator rust">,</span>
</span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span></span>

<span class="comment line documentation rust"><span class="punctuation definition comment rust">///</span> Instead of mutations being atomic (via an atomic variable), they&#39;re buffered into
</span><span class="comment line documentation rust"><span class="punctuation definition comment rust">///</span> &quot;epochs&quot;, and handled by precisely one thread.
</span><span class="meta struct rust"><span class="storage type struct rust">struct</span> </span><span class="meta struct rust"><span class="entity name struct rust">MutationBuffer</span> </span><span class="meta struct rust"><span class="meta block rust"><span class="punctuation section block begin rust">{</span>
    <span class="variable other member rust">mutation_buffer_tx</span><span class="punctuation separator rust">:</span> <span class="meta generic rust">UnboundedSender<span class="punctuation definition generic begin rust">&lt;</span>Mutation<span class="punctuation definition generic end rust">&gt;</span></span>,
    <span class="variable other member rust">mutation_buffer_rx</span><span class="punctuation separator rust">:</span> <span class="meta generic rust">Mutex<span class="punctuation definition generic begin rust">&lt;</span><span class="meta generic rust">Option<span class="punctuation definition generic begin rust">&lt;</span><span class="meta generic rust">UnboundedReceiver<span class="punctuation definition generic begin rust">&lt;</span>Mutation<span class="punctuation definition generic end rust">&gt;</span></span><span class="punctuation definition generic end rust">&gt;</span></span><span class="punctuation definition generic end rust">&gt;</span></span>,
</span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span></span>

<span class="storage modifier rust">unsafe</span> <span class="meta impl rust"><span class="storage type impl rust">impl</span> </span><span class="meta impl rust">Sync <span class="keyword other rust">for</span></span><span class="meta impl rust"> <span class="entity name impl rust">MutationBuffer</span> </span><span class="meta impl rust"><span class="meta block rust"><span class="punctuation section block begin rust">{</span></span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span></span>

<span class="meta impl rust"><span class="storage type impl rust">impl</span> </span><span class="meta impl rust">Default <span class="keyword other rust">for</span></span><span class="meta impl rust"> <span class="entity name impl rust">MutationBuffer</span> </span><span class="meta impl rust"><span class="meta block rust"><span class="punctuation section block begin rust">{</span>
    <span class="meta function rust"><span class="meta function rust"><span class="storage type function rust">fn</span> </span><span class="entity name function rust">default</span></span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters begin rust">(</span></span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters end rust">)</span></span></span></span><span class="meta function rust"> <span class="meta function return-type rust"><span class="punctuation separator rust">-&gt;</span> <span class="storage type rust">Self</span></span> </span><span class="meta function rust"><span class="meta block rust"><span class="punctuation section block begin rust">{</span>
        <span class="storage type rust">let</span> <span class="meta group rust"><span class="punctuation section group begin rust">(</span>mutation_buffer_tx<span class="punctuation separator rust">,</span> mutation_buffer_rx</span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span> <span class="keyword operator rust">=</span> <span class="support function rust">unbounded_channel</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span><span class="punctuation terminator rust">;</span>
        <span class="storage type rust">Self</span> <span class="meta block rust"><span class="punctuation section block begin rust">{</span>
            mutation_buffer_tx<span class="punctuation separator rust">,</span>
            mutation_buffer_rx<span class="punctuation separator rust">:</span> <span class="meta path rust">Mutex<span class="punctuation accessor rust">::</span></span>new<span class="meta group rust"><span class="punctuation section group begin rust">(</span><span class="support type rust">Some</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span>mutation_buffer_rx</span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span><span class="punctuation separator rust">,</span>
        </span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span>
    </span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span></span>
</span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span></span>

<span class="storage type rust">static</span> <span class="constant other rust">MUTATION_BUFFER</span><span class="punctuation separator rust">:</span> <span class="meta generic rust">OnceLock<span class="punctuation definition generic begin rust">&lt;</span>MutationBuffer<span class="punctuation definition generic end rust">&gt;</span></span> <span class="keyword operator rust">=</span> <span class="meta path rust">OnceLock<span class="punctuation accessor rust">::</span></span>new<span class="meta group rust"><span class="punctuation section group begin rust">(</span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span><span class="punctuation terminator rust">;</span>

<span class="meta function rust"><span class="meta function rust"><span class="storage type function rust">fn</span> </span><span class="entity name function rust">inc_rc</span></span><span class="meta generic rust"><span class="punctuation definition generic begin rust">&lt;</span>T<span class="punctuation separator rust">:</span> Trace<span class="punctuation definition generic end rust">&gt;</span></span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters begin rust">(</span><span class="variable parameter rust">gc</span><span class="punctuation separator rust">:</span> <span class="meta generic rust">NonNull<span class="punctuation definition generic begin rust">&lt;</span><span class="meta generic rust">GcInner<span class="punctuation definition generic begin rust">&lt;</span>T<span class="punctuation definition generic end rust">&gt;</span></span><span class="punctuation definition generic end rust">&gt;</span></span></span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters end rust">)</span></span></span></span><span class="meta function rust"> </span><span class="meta function rust"><span class="meta block rust"><span class="punctuation section block begin rust">{</span>
    <span class="comment line double-slash rust"><span class="punctuation definition comment rust">//</span> SAFETY: send takes an immutable reference and is atomic
</span>    <span class="constant other rust">MUTATION_BUFFER</span>
        .<span class="support function rust">get_or_init</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span><span class="meta path rust">MutationBuffer<span class="punctuation accessor rust">::</span></span>default</span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span>
        .mutation_buffer_tx
        .<span class="support function rust">send</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span><span class="meta path rust">Mutation<span class="punctuation accessor rust">::</span></span>new<span class="meta group rust"><span class="punctuation section group begin rust">(</span><span class="meta path rust">MutationKind<span class="punctuation accessor rust">::</span></span>Inc<span class="punctuation separator rust">,</span> gc <span class="keyword operator rust">as</span> <span class="meta generic rust">NonNull<span class="punctuation definition generic begin rust">&lt;</span>OpaqueGc<span class="punctuation definition generic end rust">&gt;</span></span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span>
        .<span class="support function rust">unwrap</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span><span class="punctuation terminator rust">;</span>
</span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span></span>

<span class="meta function rust"><span class="meta function rust"><span class="storage type function rust">fn</span> </span><span class="entity name function rust">dec_rc</span></span><span class="meta generic rust"><span class="punctuation definition generic begin rust">&lt;</span>T<span class="punctuation separator rust">:</span> Trace<span class="punctuation definition generic end rust">&gt;</span></span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters begin rust">(</span><span class="variable parameter rust">gc</span><span class="punctuation separator rust">:</span> <span class="meta generic rust">NonNull<span class="punctuation definition generic begin rust">&lt;</span><span class="meta generic rust">GcInner<span class="punctuation definition generic begin rust">&lt;</span>T<span class="punctuation definition generic end rust">&gt;</span></span><span class="punctuation definition generic end rust">&gt;</span></span></span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters end rust">)</span></span></span></span><span class="meta function rust"> </span><span class="meta function rust"><span class="meta block rust"><span class="punctuation section block begin rust">{</span>
    <span class="comment line double-slash rust"><span class="punctuation definition comment rust">//</span> SAFETY: send takes an immutable reference and is atomic
</span>    <span class="constant other rust">MUTATION_BUFFER</span>
        .<span class="support function rust">get_or_init</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span><span class="meta path rust">MutationBuffer<span class="punctuation accessor rust">::</span></span>default</span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span>
        .mutation_buffer_tx
        .<span class="support function rust">send</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span><span class="meta path rust">Mutation<span class="punctuation accessor rust">::</span></span>new<span class="meta group rust"><span class="punctuation section group begin rust">(</span><span class="meta path rust">MutationKind<span class="punctuation accessor rust">::</span></span>Dec<span class="punctuation separator rust">,</span> gc <span class="keyword operator rust">as</span> <span class="meta generic rust">NonNull<span class="punctuation definition generic begin rust">&lt;</span>OpaqueGc<span class="punctuation definition generic end rust">&gt;</span></span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span>
        .<span class="support function rust">unwrap</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span><span class="punctuation terminator rust">;</span>
</span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span></span>
</span></pre>
<p>And now we finally can implement <code>Clone</code> and <code>Drop</code> for <code>Gc&lt;T&gt;</code>:</p>
<pre class="code"><span class="source rust"><span class="meta impl rust"><span class="storage type impl rust">impl</span></span><span class="meta impl rust"><span class="meta generic rust"><span class="punctuation definition generic begin rust">&lt;</span>T<span class="punctuation separator rust">:</span> Trace<span class="punctuation definition generic end rust">&gt;</span></span></span><span class="meta impl rust"> Clone <span class="keyword other rust">for</span></span><span class="meta impl rust"> <span class="entity name impl rust">Gc</span><span class="meta generic rust"><span class="punctuation definition generic begin rust">&lt;</span>T<span class="punctuation definition generic end rust">&gt;</span></span> </span><span class="meta impl rust"><span class="meta block rust"><span class="punctuation section block begin rust">{</span>
    <span class="meta function rust"><span class="meta function rust"><span class="storage type function rust">fn</span> </span><span class="entity name function rust">clone</span></span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters begin rust">(</span><span class="keyword operator rust">&amp;</span><span class="variable parameter rust">self</span></span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters end rust">)</span></span></span></span><span class="meta function rust"> <span class="meta function return-type rust"><span class="punctuation separator rust">-&gt;</span> <span class="meta generic rust">Gc<span class="punctuation definition generic begin rust">&lt;</span>T<span class="punctuation definition generic end rust">&gt;</span></span></span> </span><span class="meta function rust"><span class="meta block rust"><span class="punctuation section block begin rust">{</span>
        <span class="support function rust">inc_rc</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span><span class="variable language rust">self</span>.ptr</span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span><span class="punctuation terminator rust">;</span>
        <span class="storage type rust">Self</span> <span class="meta block rust"><span class="punctuation section block begin rust">{</span>
            ptr<span class="punctuation separator rust">:</span> <span class="variable language rust">self</span>.ptr<span class="punctuation separator rust">,</span>
            marker<span class="punctuation separator rust">:</span> PhantomData<span class="punctuation separator rust">,</span>
        </span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span>
    </span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span></span>
</span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span></span>

<span class="meta impl rust"><span class="storage type impl rust">impl</span></span><span class="meta impl rust"><span class="meta generic rust"><span class="punctuation definition generic begin rust">&lt;</span>T<span class="punctuation separator rust">:</span> Trace<span class="punctuation definition generic end rust">&gt;</span></span></span><span class="meta impl rust"> Drop <span class="keyword other rust">for</span></span><span class="meta impl rust"> <span class="entity name impl rust">Gc</span><span class="meta generic rust"><span class="punctuation definition generic begin rust">&lt;</span>T<span class="punctuation definition generic end rust">&gt;</span></span> </span><span class="meta impl rust"><span class="meta block rust"><span class="punctuation section block begin rust">{</span>
    <span class="meta function rust"><span class="meta function rust"><span class="storage type function rust">fn</span> </span><span class="entity name function rust">drop</span></span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters begin rust">(</span><span class="keyword operator rust">&amp;</span><span class="storage modifier rust">mut</span> <span class="variable parameter rust">self</span></span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters end rust">)</span></span></span></span><span class="meta function rust"> </span><span class="meta function rust"><span class="meta block rust"><span class="punctuation section block begin rust">{</span>
        <span class="support function rust">dec_rc</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span><span class="variable language rust">self</span>.ptr</span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span><span class="punctuation terminator rust">;</span>
    </span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span></span>
</span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span></span>
</span></pre>
<p>This also presents a sturcture for our collection process: wait for some number of increments and 
decrements, process them, then decide if we want to try to perform a collection:</p>
<pre class="code"><span class="source rust"><span class="storage type rust">static</span> <span class="constant other rust">COLLECTOR_TASK</span><span class="punctuation separator rust">:</span> <span class="meta generic rust">OnceLock<span class="punctuation definition generic begin rust">&lt;</span><span class="meta generic rust">JoinHandle<span class="punctuation definition generic begin rust">&lt;</span><span class="punctuation section group begin rust">(</span><span class="punctuation section group end rust">)</span><span class="punctuation definition generic end rust">&gt;</span></span><span class="punctuation definition generic end rust">&gt;</span></span> <span class="keyword operator rust">=</span> <span class="meta path rust">OnceLock<span class="punctuation accessor rust">::</span></span>new<span class="meta group rust"><span class="punctuation section group begin rust">(</span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span><span class="punctuation terminator rust">;</span>

<span class="meta function rust"><span class="meta function rust"><span class="storage modifier rust">pub</span> <span class="storage type function rust">fn</span> </span><span class="entity name function rust">init_gc</span></span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters begin rust">(</span></span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters end rust">)</span></span></span></span><span class="meta function rust"> </span><span class="meta function rust"><span class="meta block rust"><span class="punctuation section block begin rust">{</span>
    <span class="comment line double-slash rust"><span class="punctuation definition comment rust">//</span> SAFETY: We DO NOT mutate MUTATION_BUFFER, we mutate the _interior once lock_.
</span>    <span class="storage type rust">let</span> <span class="keyword operator rust">_</span> <span class="keyword operator rust">=</span> <span class="constant other rust">MUTATION_BUFFER</span>.<span class="support function rust">get_or_init</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span><span class="meta path rust">MutationBuffer<span class="punctuation accessor rust">::</span></span>default</span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span><span class="punctuation terminator rust">;</span>
    <span class="storage type rust">let</span> <span class="keyword operator rust">_</span> <span class="keyword operator rust">=</span> <span class="constant other rust">COLLECTOR_TASK</span>
        .<span class="support function rust">get_or_init</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span><span class="meta function closure rust"><span class="meta function parameters rust"><span class="punctuation section parameters begin rust">|</span></span></span><span class="meta function closure rust"><span class="meta function parameters rust"><span class="punctuation section parameters end rust">|</span></span> </span><span class="meta function closure rust"><span class="meta path rust">tokio<span class="punctuation accessor rust">::</span></span><span class="meta path rust">task<span class="punctuation accessor rust">::</span></span>spawn<span class="meta group rust"><span class="punctuation section group begin rust">(</span>async <span class="meta block rust"><span class="punctuation section block begin rust">{</span> <span class="storage modifier rust">unsafe</span> <span class="meta block rust"><span class="punctuation section block begin rust">{</span> <span class="support function rust">run_garbage_collector</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span>.await </span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span> </span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span></span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span><span class="punctuation terminator rust">;</span>
</span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span></span>

<span class="storage type rust">const</span> <span class="constant other rust">MAX_MUTATIONS_PER_EPOCH</span><span class="punctuation separator rust">:</span> <span class="storage type rust">usize</span> <span class="keyword operator rust">=</span> <span class="constant numeric integer decimal rust">10_000</span><span class="punctuation terminator rust">;</span> <span class="comment line double-slash rust"><span class="punctuation definition comment rust">//</span> No idea what a good value is here.
</span>
async <span class="storage modifier rust">unsafe</span> <span class="meta function rust"><span class="meta function rust"><span class="storage type function rust">fn</span> </span><span class="entity name function rust">run_garbage_collector</span></span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters begin rust">(</span></span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters end rust">)</span></span></span></span><span class="meta function rust"> </span><span class="meta function rust"><span class="meta block rust"><span class="punctuation section block begin rust">{</span>
    <span class="storage type rust">let</span> <span class="storage modifier rust">mut</span> last_epoch <span class="keyword operator rust">=</span> <span class="meta path rust">Instant<span class="punctuation accessor rust">::</span></span>now<span class="meta group rust"><span class="punctuation section group begin rust">(</span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span><span class="punctuation terminator rust">;</span>
    <span class="storage type rust">let</span> <span class="storage modifier rust">mut</span> mutation_buffer_rx <span class="keyword operator rust">=</span> <span class="constant other rust">MUTATION_BUFFER</span>
        .<span class="support function rust">get_or_init</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span><span class="meta path rust">MutationBuffer<span class="punctuation accessor rust">::</span></span>default</span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span>
        .mutation_buffer_rx
        .<span class="support function rust">lock</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span>
        .<span class="support function rust">take</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span>
        .<span class="support function rust">unwrap</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span><span class="punctuation terminator rust">;</span>
    <span class="storage type rust">let</span> <span class="storage modifier rust">mut</span> mutation_buffer<span class="punctuation separator rust">:</span> <span class="meta generic rust">Vec<span class="punctuation definition generic begin rust">&lt;</span><span class="keyword operator rust">_</span><span class="punctuation definition generic end rust">&gt;</span></span> <span class="keyword operator rust">=</span> <span class="support type rust">Vec</span><span class="meta path rust"><span class="punctuation accessor rust">::</span></span>with_capacity<span class="meta group rust"><span class="punctuation section group begin rust">(</span><span class="constant other rust">MAX_MUTATIONS_PER_EPOCH</span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span><span class="punctuation terminator rust">;</span>
    <span class="keyword control rust">loop</span> <span class="meta block rust"><span class="punctuation section block begin rust">{</span>
        <span class="support function rust">epoch</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span><span class="keyword operator rust">&amp;</span><span class="storage modifier rust">mut</span> last_epoch<span class="punctuation separator rust">,</span> <span class="keyword operator rust">&amp;</span><span class="storage modifier rust">mut</span> mutation_buffer</span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span>.await<span class="punctuation terminator rust">;</span>
        mutation_buffer.<span class="support function rust">clear</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span><span class="punctuation terminator rust">;</span>
    </span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span>
</span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span></span>

async <span class="storage modifier rust">unsafe</span> <span class="meta function rust"><span class="meta function rust"><span class="storage type function rust">fn</span> </span><span class="entity name function rust">epoch</span></span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters begin rust">(</span><span class="variable parameter rust">last_epoch</span><span class="punctuation separator rust">:</span> <span class="keyword operator rust">&amp;</span><span class="storage modifier rust">mut</span> Instant, <span class="variable parameter rust">mutation_buffer</span><span class="punctuation separator rust">:</span> <span class="keyword operator rust">&amp;</span><span class="storage modifier rust">mut</span> <span class="meta generic rust">Vec<span class="punctuation definition generic begin rust">&lt;</span>Mutation<span class="punctuation definition generic end rust">&gt;</span></span></span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters end rust">)</span></span></span></span><span class="meta function rust"> </span><span class="meta function rust"><span class="meta block rust"><span class="punctuation section block begin rust">{</span>
    <span class="support function rust">process_mutation_buffer</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span>mutation_buffer</span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span>.await<span class="punctuation terminator rust">;</span>
    <span class="storage type rust">let</span> duration_since_last_epoch <span class="keyword operator rust">=</span> <span class="meta path rust">Instant<span class="punctuation accessor rust">::</span></span>now<span class="meta group rust"><span class="punctuation section group begin rust">(</span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span> <span class="keyword operator rust">-</span> <span class="keyword operator rust">*</span>last_epoch<span class="punctuation terminator rust">;</span>
    <span class="keyword control rust">if</span> duration_since_last_epoch <span class="keyword operator rust">&gt;</span> <span class="meta path rust">Duration<span class="punctuation accessor rust">::</span></span>from_millis<span class="meta group rust"><span class="punctuation section group begin rust">(</span><span class="constant numeric integer decimal rust">100</span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span> <span class="meta block rust"><span class="punctuation section block begin rust">{</span>
        <span class="meta path rust">tokio<span class="punctuation accessor rust">::</span></span><span class="meta path rust">task<span class="punctuation accessor rust">::</span></span>spawn_blocking<span class="meta group rust"><span class="punctuation section group begin rust">(</span><span class="meta function closure rust"><span class="meta function parameters rust"><span class="punctuation section parameters begin rust">|</span></span></span><span class="meta function closure rust"><span class="meta function parameters rust"><span class="punctuation section parameters end rust">|</span></span> </span><span class="meta function closure rust"><span class="storage modifier rust">unsafe</span> <span class="meta block rust"><span class="punctuation section block begin rust">{</span> <span class="support function rust">process_cycles</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span> </span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span></span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span>
            .await
            .<span class="support function rust">unwrap</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span><span class="punctuation terminator rust">;</span>
        <span class="keyword operator rust">*</span>last_epoch <span class="keyword operator rust">=</span> <span class="meta path rust">Instant<span class="punctuation accessor rust">::</span></span>now<span class="meta group rust"><span class="punctuation section group begin rust">(</span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span><span class="punctuation terminator rust">;</span>
    </span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span>
</span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span></span>

<span class="comment line documentation rust"><span class="punctuation definition comment rust">///</span> SAFETY: this function is _not reentrant_, may only be called by once per epoch,
</span><span class="comment line documentation rust"><span class="punctuation definition comment rust">///</span> and must _complete_ before the next epoch.
</span>async <span class="storage modifier rust">unsafe</span> <span class="meta function rust"><span class="meta function rust"><span class="storage type function rust">fn</span> </span><span class="entity name function rust">process_mutation_buffer</span></span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters begin rust">(</span>
    <span class="variable parameter rust">mutation_buffer_rx</span><span class="punctuation separator rust">:</span> <span class="keyword operator rust">&amp;</span><span class="storage modifier rust">mut</span> <span class="meta generic rust">UnboundedReceiver<span class="punctuation definition generic begin rust">&lt;</span>Mutation<span class="punctuation definition generic end rust">&gt;</span></span>,
    <span class="variable parameter rust">mutation_buffer</span><span class="punctuation separator rust">:</span> <span class="keyword operator rust">&amp;</span><span class="storage modifier rust">mut</span> <span class="meta generic rust">Vec<span class="punctuation definition generic begin rust">&lt;</span>Mutation<span class="punctuation definition generic end rust">&gt;</span></span>
</span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters end rust">)</span></span></span></span><span class="meta function rust"> </span><span class="meta function rust"><span class="meta block rust"><span class="punctuation section block begin rust">{</span>
    <span class="comment line double-slash rust"><span class="punctuation definition comment rust">//</span> SAFETY: This function has _exclusive access_ to mutate the header of
</span>    <span class="comment line double-slash rust"><span class="punctuation definition comment rust">//</span> _every_ garbage collected object. It does so _only now_.
</span>    mutation_buffer_rx
        .<span class="support function rust">recv_many</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span>mutation_buffer<span class="punctuation separator rust">,</span> <span class="constant other rust">MAX_MUTATIONS_PER_EPOCH</span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span>
        .await<span class="punctuation terminator rust">;</span>

    <span class="keyword control rust">for</span> mutation <span class="keyword operator rust">in</span> mutation_buffer <span class="meta block rust"><span class="punctuation section block begin rust">{</span>
        <span class="keyword control rust">match</span> mutation.kind <span class="meta block rust"><span class="punctuation section block begin rust">{</span>
            <span class="meta path rust">MutationKind<span class="punctuation accessor rust">::</span></span>Inc <span class="keyword operator rust">=&gt;</span> <span class="support function rust">increment</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span>mutation.gc</span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span><span class="punctuation separator rust">,</span>
            <span class="meta path rust">MutationKind<span class="punctuation accessor rust">::</span></span>Dec <span class="keyword operator rust">=&gt;</span> <span class="support function rust">decrement</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span>mutation.gc</span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span><span class="punctuation separator rust">,</span>
        </span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span>
    </span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span>
</span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span></span>
</span></pre>
<p>With all of this set up, we can fill in rest of the functions:</p>
<pre class="code"><span class="source rust"><span class="comment line double-slash rust"><span class="punctuation definition comment rust">//</span> SAFETY: These values can only be accessed by one thread at once.
</span><span class="storage type rust">static</span> <span class="storage modifier rust">mut</span> <span class="constant other rust">ROOTS</span><span class="punctuation separator rust">:</span> <span class="meta generic rust">Vec<span class="punctuation definition generic begin rust">&lt;</span>OpaqueGcPtr<span class="punctuation definition generic end rust">&gt;</span></span> <span class="keyword operator rust">=</span> <span class="support type rust">Vec</span><span class="meta path rust"><span class="punctuation accessor rust">::</span></span>new<span class="meta group rust"><span class="punctuation section group begin rust">(</span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span><span class="punctuation terminator rust">;</span>
<span class="storage type rust">static</span> <span class="storage modifier rust">mut</span> <span class="constant other rust">CYCLE_BUFFER</span><span class="punctuation separator rust">:</span> <span class="meta generic rust">Vec<span class="punctuation definition generic begin rust">&lt;</span><span class="meta generic rust">Vec<span class="punctuation definition generic begin rust">&lt;</span>OpaqueGcPtr<span class="punctuation definition generic end rust">&gt;</span></span><span class="punctuation definition generic end rust">&gt;</span></span> <span class="keyword operator rust">=</span> <span class="support type rust">Vec</span><span class="meta path rust"><span class="punctuation accessor rust">::</span></span>new<span class="meta group rust"><span class="punctuation section group begin rust">(</span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span><span class="punctuation terminator rust">;</span>
<span class="storage type rust">static</span> <span class="storage modifier rust">mut</span> <span class="constant other rust">CURRENT_CYCLE</span><span class="punctuation separator rust">:</span> <span class="meta generic rust">Vec<span class="punctuation definition generic begin rust">&lt;</span>OpaqueGcPtr<span class="punctuation definition generic end rust">&gt;</span></span> <span class="keyword operator rust">=</span> <span class="support type rust">Vec</span><span class="meta path rust"><span class="punctuation accessor rust">::</span></span>new<span class="meta group rust"><span class="punctuation section group begin rust">(</span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span><span class="punctuation terminator rust">;</span>

<span class="storage modifier rust">unsafe</span> <span class="meta function rust"><span class="meta function rust"><span class="storage type function rust">fn</span> </span><span class="entity name function rust">increment</span></span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters begin rust">(</span><span class="variable parameter rust">s</span><span class="punctuation separator rust">:</span> OpaqueGcPtr</span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters end rust">)</span></span></span></span><span class="meta function rust"> </span><span class="meta function rust"><span class="meta block rust"><span class="punctuation section block begin rust">{</span>
    <span class="keyword operator rust">*</span><span class="support function rust">rc</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span>s</span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span> <span class="keyword operator rust">+</span><span class="keyword operator rust">=</span> <span class="constant numeric integer decimal rust">1</span><span class="punctuation terminator rust">;</span>
    <span class="support function rust">scan_black</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span>s</span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span><span class="punctuation terminator rust">;</span>
</span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span></span>

<span class="storage modifier rust">unsafe</span> <span class="meta function rust"><span class="meta function rust"><span class="storage type function rust">fn</span> </span><span class="entity name function rust">decrement</span></span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters begin rust">(</span><span class="variable parameter rust">s</span><span class="punctuation separator rust">:</span> OpaqueGcPtr</span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters end rust">)</span></span></span></span><span class="meta function rust"> </span><span class="meta function rust"><span class="meta block rust"><span class="punctuation section block begin rust">{</span>
    <span class="keyword operator rust">*</span><span class="support function rust">rc</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span>s</span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span> <span class="keyword operator rust">-</span><span class="keyword operator rust">=</span> <span class="constant numeric integer decimal rust">1</span><span class="punctuation terminator rust">;</span>
    <span class="keyword control rust">if</span> <span class="keyword operator rust">*</span><span class="support function rust">rc</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span>s</span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span> <span class="keyword operator rust">=</span><span class="keyword operator rust">=</span> <span class="constant numeric integer decimal rust">0</span> <span class="meta block rust"><span class="punctuation section block begin rust">{</span>
        <span class="support function rust">release</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span>s</span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span><span class="punctuation terminator rust">;</span>
    </span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span> <span class="keyword control rust">else</span> <span class="meta block rust"><span class="punctuation section block begin rust">{</span>
        <span class="support function rust">possible_root</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span>s</span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span><span class="punctuation terminator rust">;</span>
    </span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span>
</span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span></span>

<span class="storage modifier rust">unsafe</span> <span class="meta function rust"><span class="meta function rust"><span class="storage type function rust">fn</span> </span><span class="entity name function rust">release</span></span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters begin rust">(</span><span class="variable parameter rust">s</span><span class="punctuation separator rust">:</span> OpaqueGcPtr</span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters end rust">)</span></span></span></span><span class="meta function rust"> </span><span class="meta function rust"><span class="meta block rust"><span class="punctuation section block begin rust">{</span>
    <span class="support function rust">for_each_child</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span>s<span class="punctuation separator rust">,</span> decrement</span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span><span class="punctuation terminator rust">;</span>
    <span class="keyword operator rust">*</span><span class="support function rust">color</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span>s</span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span> <span class="keyword operator rust">=</span> <span class="meta path rust">Color<span class="punctuation accessor rust">::</span></span>Black<span class="punctuation terminator rust">;</span>
    <span class="keyword control rust">if</span> <span class="keyword operator rust">!</span><span class="keyword operator rust">*</span><span class="support function rust">buffered</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span>s</span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span> <span class="meta block rust"><span class="punctuation section block begin rust">{</span>
        <span class="support function rust">free</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span>s</span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span><span class="punctuation terminator rust">;</span>
    </span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span>
</span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span></span>

<span class="storage modifier rust">unsafe</span> <span class="meta function rust"><span class="meta function rust"><span class="storage type function rust">fn</span> </span><span class="entity name function rust">possible_root</span></span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters begin rust">(</span><span class="variable parameter rust">s</span><span class="punctuation separator rust">:</span> OpaqueGcPtr</span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters end rust">)</span></span></span></span><span class="meta function rust"> </span><span class="meta function rust"><span class="meta block rust"><span class="punctuation section block begin rust">{</span>
    <span class="support function rust">scan_black</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span>s</span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span><span class="punctuation terminator rust">;</span>
    <span class="keyword operator rust">*</span><span class="support function rust">color</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span>s</span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span> <span class="keyword operator rust">=</span> <span class="meta path rust">Color<span class="punctuation accessor rust">::</span></span>Purple<span class="punctuation terminator rust">;</span>
    <span class="keyword control rust">if</span> <span class="keyword operator rust">!</span><span class="keyword operator rust">*</span><span class="support function rust">buffered</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span>s</span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span> <span class="meta block rust"><span class="punctuation section block begin rust">{</span>
        <span class="keyword operator rust">*</span><span class="support function rust">buffered</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span>s</span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span> <span class="keyword operator rust">=</span> <span class="constant language rust">true</span><span class="punctuation terminator rust">;</span>
        <span class="meta group rust"><span class="punctuation section group begin rust">(</span><span class="keyword operator rust">&amp;</span>raw <span class="storage modifier rust">mut</span> <span class="constant other rust">ROOTS</span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span>.<span class="support function rust">as_mut</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span>.<span class="support function rust">unwrap</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span>.<span class="support function rust">push</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span>s</span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span><span class="punctuation terminator rust">;</span>
    </span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span>
</span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span></span>

<span class="storage modifier rust">unsafe</span> <span class="meta function rust"><span class="meta function rust"><span class="storage type function rust">fn</span> </span><span class="entity name function rust">process_cycles</span></span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters begin rust">(</span></span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters end rust">)</span></span></span></span><span class="meta function rust"> </span><span class="meta function rust"><span class="meta block rust"><span class="punctuation section block begin rust">{</span>
    <span class="support function rust">free_cycles</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span><span class="punctuation terminator rust">;</span>
    <span class="support function rust">collect_cycles</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span><span class="punctuation terminator rust">;</span>
    <span class="support function rust">sigma_preparation</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span><span class="punctuation terminator rust">;</span>
</span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span></span>

<span class="storage modifier rust">unsafe</span> <span class="meta function rust"><span class="meta function rust"><span class="storage type function rust">fn</span> </span><span class="entity name function rust">collect_cycles</span></span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters begin rust">(</span></span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters end rust">)</span></span></span></span><span class="meta function rust"> </span><span class="meta function rust"><span class="meta block rust"><span class="punctuation section block begin rust">{</span>
    <span class="support function rust">mark_roots</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span><span class="punctuation terminator rust">;</span>
    <span class="support function rust">scan_roots</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span><span class="punctuation terminator rust">;</span>
    <span class="support function rust">collect_roots</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span><span class="punctuation terminator rust">;</span>
</span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span></span>

<span class="comment line double-slash rust"><span class="punctuation definition comment rust">//</span> SAFETY: No function called by mark_roots may access ROOTS
</span><span class="storage modifier rust">unsafe</span> <span class="meta function rust"><span class="meta function rust"><span class="storage type function rust">fn</span> </span><span class="entity name function rust">mark_roots</span></span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters begin rust">(</span></span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters end rust">)</span></span></span></span><span class="meta function rust"> </span><span class="meta function rust"><span class="meta block rust"><span class="punctuation section block begin rust">{</span>
    <span class="storage type rust">let</span> <span class="storage modifier rust">mut</span> new_roots <span class="keyword operator rust">=</span> <span class="support type rust">Vec</span><span class="meta path rust"><span class="punctuation accessor rust">::</span></span>new<span class="meta group rust"><span class="punctuation section group begin rust">(</span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span><span class="punctuation terminator rust">;</span>
    <span class="keyword control rust">for</span> s <span class="keyword operator rust">in</span> <span class="meta group rust"><span class="punctuation section group begin rust">(</span><span class="keyword operator rust">&amp;</span>raw <span class="storage type rust">const</span> <span class="constant other rust">ROOTS</span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span>.<span class="support function rust">as_ref</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span>.<span class="support function rust">unwrap</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span>.<span class="support function rust">iter</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span> <span class="meta block rust"><span class="punctuation section block begin rust">{</span>
        <span class="keyword control rust">if</span> <span class="keyword operator rust">*</span><span class="support function rust">color</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span><span class="keyword operator rust">*</span>s</span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span> <span class="keyword operator rust">=</span><span class="keyword operator rust">=</span> <span class="meta path rust">Color<span class="punctuation accessor rust">::</span></span>Purple <span class="keyword operator rust">&amp;</span><span class="keyword operator rust">&amp;</span> <span class="keyword operator rust">*</span><span class="support function rust">rc</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span><span class="keyword operator rust">*</span>s</span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span> <span class="keyword operator rust">&gt;</span> <span class="constant numeric integer decimal rust">0</span> <span class="meta block rust"><span class="punctuation section block begin rust">{</span>
            <span class="support function rust">mark_gray</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span><span class="keyword operator rust">*</span>s</span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span><span class="punctuation terminator rust">;</span>
            new_roots.<span class="support function rust">push</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span><span class="keyword operator rust">*</span>s</span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span><span class="punctuation terminator rust">;</span>
        </span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span> <span class="keyword control rust">else</span> <span class="meta block rust"><span class="punctuation section block begin rust">{</span>
            <span class="keyword operator rust">*</span><span class="support function rust">buffered</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span><span class="keyword operator rust">*</span>s</span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span> <span class="keyword operator rust">=</span> <span class="constant language rust">false</span><span class="punctuation terminator rust">;</span>
            <span class="keyword control rust">if</span> <span class="keyword operator rust">*</span><span class="support function rust">rc</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span><span class="keyword operator rust">*</span>s</span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span> <span class="keyword operator rust">=</span><span class="keyword operator rust">=</span> <span class="constant numeric integer decimal rust">0</span> <span class="meta block rust"><span class="punctuation section block begin rust">{</span>
                <span class="support function rust">free</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span><span class="keyword operator rust">*</span>s</span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span><span class="punctuation terminator rust">;</span>
            </span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span>
        </span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span>
    </span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span>
    <span class="constant other rust">ROOTS</span> <span class="keyword operator rust">=</span> new_roots<span class="punctuation terminator rust">;</span>
</span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span></span>

<span class="storage modifier rust">unsafe</span> <span class="meta function rust"><span class="meta function rust"><span class="storage type function rust">fn</span> </span><span class="entity name function rust">scan_roots</span></span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters begin rust">(</span></span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters end rust">)</span></span></span></span><span class="meta function rust"> </span><span class="meta function rust"><span class="meta block rust"><span class="punctuation section block begin rust">{</span>
    <span class="keyword control rust">for</span> s <span class="keyword operator rust">in</span> <span class="meta group rust"><span class="punctuation section group begin rust">(</span><span class="keyword operator rust">&amp;</span>raw <span class="storage type rust">const</span> <span class="constant other rust">ROOTS</span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span>.<span class="support function rust">as_ref</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span>.<span class="support function rust">unwrap</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span>.<span class="support function rust">iter</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span> <span class="meta block rust"><span class="punctuation section block begin rust">{</span>
        <span class="support function rust">scan</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span><span class="keyword operator rust">*</span>s</span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span>
    </span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span>
</span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span></span>

<span class="storage modifier rust">unsafe</span> <span class="meta function rust"><span class="meta function rust"><span class="storage type function rust">fn</span> </span><span class="entity name function rust">collect_roots</span></span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters begin rust">(</span></span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters end rust">)</span></span></span></span><span class="meta function rust"> </span><span class="meta function rust"><span class="meta block rust"><span class="punctuation section block begin rust">{</span>
    <span class="keyword control rust">for</span> s <span class="keyword operator rust">in</span> <span class="meta path rust">std<span class="punctuation accessor rust">::</span></span><span class="meta path rust">mem<span class="punctuation accessor rust">::</span></span>take<span class="meta group rust"><span class="punctuation section group begin rust">(</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span><span class="keyword operator rust">&amp;</span>raw <span class="storage modifier rust">mut</span> <span class="constant other rust">ROOTS</span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span>.<span class="support function rust">as_mut</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span>.<span class="support function rust">unwrap</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span> <span class="meta block rust"><span class="punctuation section block begin rust">{</span>
        <span class="keyword control rust">if</span> <span class="keyword operator rust">*</span><span class="support function rust">color</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span>s</span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span> <span class="keyword operator rust">=</span><span class="keyword operator rust">=</span> <span class="meta path rust">Color<span class="punctuation accessor rust">::</span></span>White <span class="meta block rust"><span class="punctuation section block begin rust">{</span>
            <span class="support function rust">collect_white</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span>s</span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span><span class="punctuation terminator rust">;</span>
            <span class="storage type rust">let</span> current_cycle <span class="keyword operator rust">=</span> <span class="meta path rust">std<span class="punctuation accessor rust">::</span></span><span class="meta path rust">mem<span class="punctuation accessor rust">::</span></span>take<span class="meta group rust"><span class="punctuation section group begin rust">(</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span><span class="keyword operator rust">&amp;</span>raw <span class="storage modifier rust">mut</span> <span class="constant other rust">CURRENT_CYCLE</span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span>.<span class="support function rust">as_mut</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span>.<span class="support function rust">unwrap</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span><span class="punctuation terminator rust">;</span>
            <span class="meta group rust"><span class="punctuation section group begin rust">(</span><span class="keyword operator rust">&amp;</span>raw <span class="storage modifier rust">mut</span> <span class="constant other rust">CYCLE_BUFFER</span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span>
                .<span class="support function rust">as_mut</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span>
                .<span class="support function rust">unwrap</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span>
                .<span class="support function rust">push</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span>current_cycle</span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span><span class="punctuation terminator rust">;</span>
        </span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span> <span class="keyword control rust">else</span> <span class="meta block rust"><span class="punctuation section block begin rust">{</span>
            <span class="keyword operator rust">*</span><span class="support function rust">buffered</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span>s</span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span> <span class="keyword operator rust">=</span> <span class="constant language rust">false</span><span class="punctuation terminator rust">;</span>
        </span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span>
    </span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span>
</span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span></span>

<span class="storage modifier rust">unsafe</span> <span class="meta function rust"><span class="meta function rust"><span class="storage type function rust">fn</span> </span><span class="entity name function rust">mark_gray</span></span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters begin rust">(</span><span class="variable parameter rust">s</span><span class="punctuation separator rust">:</span> OpaqueGcPtr</span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters end rust">)</span></span></span></span><span class="meta function rust"> </span><span class="meta function rust"><span class="meta block rust"><span class="punctuation section block begin rust">{</span>
    <span class="keyword control rust">if</span> <span class="keyword operator rust">*</span><span class="support function rust">color</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span>s</span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span> <span class="keyword operator rust">!</span><span class="keyword operator rust">=</span> <span class="meta path rust">Color<span class="punctuation accessor rust">::</span></span>Gray <span class="meta block rust"><span class="punctuation section block begin rust">{</span>
        <span class="keyword operator rust">*</span><span class="support function rust">color</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span>s</span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span> <span class="keyword operator rust">=</span> <span class="meta path rust">Color<span class="punctuation accessor rust">::</span></span>Gray<span class="punctuation terminator rust">;</span>
        <span class="keyword operator rust">*</span><span class="support function rust">crc</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span>s</span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span> <span class="keyword operator rust">=</span> <span class="keyword operator rust">*</span><span class="support function rust">rc</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span>s</span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span> <span class="keyword operator rust">as</span> <span class="storage type rust">isize</span><span class="punctuation terminator rust">;</span>
        <span class="support function rust">for_each_child</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span>s<span class="punctuation separator rust">,</span> <span class="meta function closure rust"><span class="meta function parameters rust"><span class="punctuation section parameters begin rust">|</span></span></span><span class="meta function closure rust"><span class="meta function parameters rust"><span class="variable parameter rust">t</span><span class="punctuation section parameters end rust">|</span></span> </span><span class="meta function closure rust"><span class="meta block rust"><span class="punctuation section block begin rust">{</span>
            <span class="support function rust">mark_gray</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span>t</span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span><span class="punctuation terminator rust">;</span>
            <span class="keyword control rust">if</span> <span class="keyword operator rust">*</span><span class="support function rust">crc</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span>t</span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span> <span class="keyword operator rust">&gt;</span> <span class="constant numeric integer decimal rust">0</span> <span class="meta block rust"><span class="punctuation section block begin rust">{</span>
                <span class="keyword operator rust">*</span><span class="support function rust">crc</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span>t</span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span> <span class="keyword operator rust">-</span><span class="keyword operator rust">=</span> <span class="constant numeric integer decimal rust">1</span><span class="punctuation terminator rust">;</span>
            </span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span>
        </span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span></span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span><span class="punctuation terminator rust">;</span>
    </span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span>
</span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span></span>

<span class="storage modifier rust">unsafe</span> <span class="meta function rust"><span class="meta function rust"><span class="storage type function rust">fn</span> </span><span class="entity name function rust">scan</span></span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters begin rust">(</span><span class="variable parameter rust">s</span><span class="punctuation separator rust">:</span> OpaqueGcPtr</span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters end rust">)</span></span></span></span><span class="meta function rust"> </span><span class="meta function rust"><span class="meta block rust"><span class="punctuation section block begin rust">{</span>
    <span class="keyword control rust">if</span> <span class="keyword operator rust">*</span><span class="support function rust">color</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span>s</span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span> <span class="keyword operator rust">=</span><span class="keyword operator rust">=</span> <span class="meta path rust">Color<span class="punctuation accessor rust">::</span></span>Gray <span class="meta block rust"><span class="punctuation section block begin rust">{</span>
        <span class="keyword control rust">if</span> <span class="keyword operator rust">*</span><span class="support function rust">crc</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span>s</span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span> <span class="keyword operator rust">=</span><span class="keyword operator rust">=</span> <span class="constant numeric integer decimal rust">0</span> <span class="meta block rust"><span class="punctuation section block begin rust">{</span>
            <span class="keyword operator rust">*</span><span class="support function rust">color</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span>s</span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span> <span class="keyword operator rust">=</span> <span class="meta path rust">Color<span class="punctuation accessor rust">::</span></span>White<span class="punctuation terminator rust">;</span>
            <span class="support function rust">for_each_child</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span>s<span class="punctuation separator rust">,</span> scan</span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span><span class="punctuation terminator rust">;</span>
        </span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span> <span class="keyword control rust">else</span> <span class="meta block rust"><span class="punctuation section block begin rust">{</span>
            <span class="support function rust">scan_black</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span>s</span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span><span class="punctuation terminator rust">;</span>
        </span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span>
    </span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span>
</span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span></span>

<span class="storage modifier rust">unsafe</span> <span class="meta function rust"><span class="meta function rust"><span class="storage type function rust">fn</span> </span><span class="entity name function rust">scan_black</span></span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters begin rust">(</span><span class="variable parameter rust">s</span><span class="punctuation separator rust">:</span> OpaqueGcPtr</span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters end rust">)</span></span></span></span><span class="meta function rust"> </span><span class="meta function rust"><span class="meta block rust"><span class="punctuation section block begin rust">{</span>
    <span class="keyword control rust">if</span> <span class="keyword operator rust">*</span><span class="support function rust">color</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span>s</span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span> <span class="keyword operator rust">!</span><span class="keyword operator rust">=</span> <span class="meta path rust">Color<span class="punctuation accessor rust">::</span></span>Black <span class="meta block rust"><span class="punctuation section block begin rust">{</span>
        <span class="keyword operator rust">*</span><span class="support function rust">color</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span>s</span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span> <span class="keyword operator rust">=</span> <span class="meta path rust">Color<span class="punctuation accessor rust">::</span></span>Black<span class="punctuation terminator rust">;</span>
        <span class="support function rust">for_each_child</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span>s<span class="punctuation separator rust">,</span> scan_black</span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span><span class="punctuation terminator rust">;</span>
    </span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span>
</span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span></span>

<span class="storage modifier rust">unsafe</span> <span class="meta function rust"><span class="meta function rust"><span class="storage type function rust">fn</span> </span><span class="entity name function rust">collect_white</span></span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters begin rust">(</span><span class="variable parameter rust">s</span><span class="punctuation separator rust">:</span> OpaqueGcPtr</span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters end rust">)</span></span></span></span><span class="meta function rust"> </span><span class="meta function rust"><span class="meta block rust"><span class="punctuation section block begin rust">{</span>
    <span class="keyword control rust">if</span> <span class="keyword operator rust">*</span><span class="support function rust">color</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span>s</span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span> <span class="keyword operator rust">=</span><span class="keyword operator rust">=</span> <span class="meta path rust">Color<span class="punctuation accessor rust">::</span></span>White <span class="meta block rust"><span class="punctuation section block begin rust">{</span>
        <span class="keyword operator rust">*</span><span class="support function rust">color</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span>s</span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span> <span class="keyword operator rust">=</span> <span class="meta path rust">Color<span class="punctuation accessor rust">::</span></span>Orange<span class="punctuation terminator rust">;</span>
        <span class="keyword operator rust">*</span><span class="support function rust">buffered</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span>s</span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span> <span class="keyword operator rust">=</span> <span class="constant language rust">true</span><span class="punctuation terminator rust">;</span>
        <span class="meta group rust"><span class="punctuation section group begin rust">(</span><span class="keyword operator rust">&amp;</span>raw <span class="storage modifier rust">mut</span> <span class="constant other rust">CURRENT_CYCLE</span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span>.<span class="support function rust">as_mut</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span>.<span class="support function rust">unwrap</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span>.<span class="support function rust">push</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span>s</span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span><span class="punctuation terminator rust">;</span>
        <span class="support function rust">for_each_child</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span>s<span class="punctuation separator rust">,</span> collect_white</span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span><span class="punctuation terminator rust">;</span>
    </span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span>
</span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span></span>

<span class="storage modifier rust">unsafe</span> <span class="meta function rust"><span class="meta function rust"><span class="storage type function rust">fn</span> </span><span class="entity name function rust">sigma_preparation</span></span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters begin rust">(</span></span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters end rust">)</span></span></span></span><span class="meta function rust"> </span><span class="meta function rust"><span class="meta block rust"><span class="punctuation section block begin rust">{</span>
    <span class="keyword control rust">for</span> c <span class="keyword operator rust">in</span> <span class="meta group rust"><span class="punctuation section group begin rust">(</span><span class="keyword operator rust">&amp;</span>raw <span class="storage type rust">const</span> <span class="constant other rust">CYCLE_BUFFER</span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span>.<span class="support function rust">as_ref</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span>.<span class="support function rust">unwrap</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span> <span class="meta block rust"><span class="punctuation section block begin rust">{</span>
        <span class="keyword control rust">for</span> n <span class="keyword operator rust">in</span> c <span class="meta block rust"><span class="punctuation section block begin rust">{</span>
            <span class="keyword operator rust">*</span><span class="support function rust">color</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span><span class="keyword operator rust">*</span>n</span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span> <span class="keyword operator rust">=</span> <span class="meta path rust">Color<span class="punctuation accessor rust">::</span></span>Red<span class="punctuation terminator rust">;</span>
            <span class="keyword operator rust">*</span><span class="support function rust">crc</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span><span class="keyword operator rust">*</span>n</span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span> <span class="keyword operator rust">=</span> <span class="keyword operator rust">*</span><span class="support function rust">rc</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span><span class="keyword operator rust">*</span>n</span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span> <span class="keyword operator rust">as</span> <span class="storage type rust">isize</span><span class="punctuation terminator rust">;</span>
        </span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span>
        <span class="keyword control rust">for</span> n <span class="keyword operator rust">in</span> c <span class="meta block rust"><span class="punctuation section block begin rust">{</span>
            <span class="support function rust">for_each_child</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span><span class="keyword operator rust">*</span>n<span class="punctuation separator rust">,</span> <span class="meta function closure rust"><span class="meta function parameters rust"><span class="punctuation section parameters begin rust">|</span></span></span><span class="meta function closure rust"><span class="meta function parameters rust"><span class="variable parameter rust">m</span><span class="punctuation section parameters end rust">|</span></span> </span><span class="meta function closure rust"><span class="meta block rust"><span class="punctuation section block begin rust">{</span>
                <span class="keyword control rust">if</span> <span class="keyword operator rust">*</span><span class="support function rust">color</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span>m</span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span> <span class="keyword operator rust">=</span><span class="keyword operator rust">=</span> <span class="meta path rust">Color<span class="punctuation accessor rust">::</span></span>Red <span class="keyword operator rust">&amp;</span><span class="keyword operator rust">&amp;</span> <span class="keyword operator rust">*</span><span class="support function rust">crc</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span>m</span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span> <span class="keyword operator rust">&gt;</span> <span class="constant numeric integer decimal rust">0</span> <span class="meta block rust"><span class="punctuation section block begin rust">{</span>
                    <span class="keyword operator rust">*</span><span class="support function rust">crc</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span>m</span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span> <span class="keyword operator rust">-</span><span class="keyword operator rust">=</span> <span class="constant numeric integer decimal rust">1</span><span class="punctuation terminator rust">;</span>
                </span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span>
            </span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span></span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span><span class="punctuation terminator rust">;</span>
        </span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span>
        <span class="keyword control rust">for</span> n <span class="keyword operator rust">in</span> c <span class="meta block rust"><span class="punctuation section block begin rust">{</span>
            <span class="keyword operator rust">*</span><span class="support function rust">color</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span><span class="keyword operator rust">*</span>n</span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span> <span class="keyword operator rust">=</span> <span class="meta path rust">Color<span class="punctuation accessor rust">::</span></span>Orange<span class="punctuation terminator rust">;</span>
        </span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span>
    </span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span>
</span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span></span>

<span class="storage modifier rust">unsafe</span> <span class="meta function rust"><span class="meta function rust"><span class="storage type function rust">fn</span> </span><span class="entity name function rust">free_cycles</span></span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters begin rust">(</span></span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters end rust">)</span></span></span></span><span class="meta function rust"> </span><span class="meta function rust"><span class="meta block rust"><span class="punctuation section block begin rust">{</span>
    <span class="keyword control rust">for</span> c <span class="keyword operator rust">in</span> <span class="meta path rust">std<span class="punctuation accessor rust">::</span></span><span class="meta path rust">mem<span class="punctuation accessor rust">::</span></span>take<span class="meta group rust"><span class="punctuation section group begin rust">(</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span><span class="keyword operator rust">&amp;</span>raw <span class="storage modifier rust">mut</span> <span class="constant other rust">CYCLE_BUFFER</span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span>.<span class="support function rust">as_mut</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span>.<span class="support function rust">unwrap</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span>
        .<span class="support function rust">into_iter</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span>
        .<span class="support function rust">rev</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span>
    <span class="meta block rust"><span class="punctuation section block begin rust">{</span>
        <span class="keyword control rust">if</span> <span class="support function rust">delta_test</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span><span class="keyword operator rust">&amp;</span>c</span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span> <span class="keyword operator rust">&amp;</span><span class="keyword operator rust">&amp;</span> <span class="support function rust">sigma_test</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span><span class="keyword operator rust">&amp;</span>c</span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span> <span class="meta block rust"><span class="punctuation section block begin rust">{</span>
            <span class="support function rust">free_cycle</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span><span class="keyword operator rust">&amp;</span>c</span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span><span class="punctuation terminator rust">;</span>
        </span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span> <span class="keyword control rust">else</span> <span class="meta block rust"><span class="punctuation section block begin rust">{</span>
            <span class="support function rust">refurbish</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span><span class="keyword operator rust">&amp;</span>c</span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span><span class="punctuation terminator rust">;</span>
        </span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span>
    </span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span>
</span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span></span>

<span class="storage modifier rust">unsafe</span> <span class="meta function rust"><span class="meta function rust"><span class="storage type function rust">fn</span> </span><span class="entity name function rust">delta_test</span></span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters begin rust">(</span><span class="variable parameter rust">c</span><span class="punctuation separator rust">:</span> <span class="keyword operator rust">&amp;</span>[OpaqueGcPtr]</span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters end rust">)</span></span></span></span><span class="meta function rust"> <span class="meta function return-type rust"><span class="punctuation separator rust">-&gt;</span> <span class="storage type rust">bool</span></span> </span><span class="meta function rust"><span class="meta block rust"><span class="punctuation section block begin rust">{</span>
    <span class="keyword control rust">for</span> n <span class="keyword operator rust">in</span> c <span class="meta block rust"><span class="punctuation section block begin rust">{</span>
        <span class="keyword control rust">if</span> <span class="keyword operator rust">*</span><span class="support function rust">color</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span><span class="keyword operator rust">*</span>n</span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span> <span class="keyword operator rust">!</span><span class="keyword operator rust">=</span> <span class="meta path rust">Color<span class="punctuation accessor rust">::</span></span>Orange <span class="meta block rust"><span class="punctuation section block begin rust">{</span>
            <span class="keyword control rust">return</span> <span class="constant language rust">false</span><span class="punctuation terminator rust">;</span>
        </span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span>
    </span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span>
    <span class="constant language rust">true</span>
</span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span></span>

<span class="storage modifier rust">unsafe</span> <span class="meta function rust"><span class="meta function rust"><span class="storage type function rust">fn</span> </span><span class="entity name function rust">sigma_test</span></span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters begin rust">(</span><span class="variable parameter rust">c</span><span class="punctuation separator rust">:</span> <span class="keyword operator rust">&amp;</span>[OpaqueGcPtr]</span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters end rust">)</span></span></span></span><span class="meta function rust"> <span class="meta function return-type rust"><span class="punctuation separator rust">-&gt;</span> <span class="storage type rust">bool</span></span> </span><span class="meta function rust"><span class="meta block rust"><span class="punctuation section block begin rust">{</span>
    <span class="keyword control rust">for</span> n <span class="keyword operator rust">in</span> c <span class="meta block rust"><span class="punctuation section block begin rust">{</span>
        <span class="keyword control rust">if</span> <span class="keyword operator rust">*</span><span class="support function rust">crc</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span><span class="keyword operator rust">*</span>n</span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span> <span class="keyword operator rust">&gt;</span> <span class="constant numeric integer decimal rust">0</span> <span class="meta block rust"><span class="punctuation section block begin rust">{</span>
            <span class="keyword control rust">return</span> <span class="constant language rust">false</span><span class="punctuation terminator rust">;</span>
        </span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span>
    </span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span>
    <span class="constant language rust">true</span>
</span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span></span>

<span class="storage modifier rust">unsafe</span> <span class="meta function rust"><span class="meta function rust"><span class="storage type function rust">fn</span> </span><span class="entity name function rust">refurbish</span></span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters begin rust">(</span><span class="variable parameter rust">c</span><span class="punctuation separator rust">:</span> <span class="keyword operator rust">&amp;</span>[OpaqueGcPtr]</span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters end rust">)</span></span></span></span><span class="meta function rust"> </span><span class="meta function rust"><span class="meta block rust"><span class="punctuation section block begin rust">{</span>
    <span class="keyword control rust">for</span> <span class="meta group rust"><span class="punctuation section group begin rust">(</span>i<span class="punctuation separator rust">,</span> n</span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span> <span class="keyword operator rust">in</span> c.<span class="support function rust">iter</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span>.<span class="support function rust">enumerate</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span> <span class="meta block rust"><span class="punctuation section block begin rust">{</span>
        <span class="keyword control rust">match</span> <span class="meta group rust"><span class="punctuation section group begin rust">(</span>i<span class="punctuation separator rust">,</span> <span class="keyword operator rust">*</span><span class="support function rust">color</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span><span class="keyword operator rust">*</span>n</span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span> <span class="meta block rust"><span class="punctuation section block begin rust">{</span>
            <span class="meta group rust"><span class="punctuation section group begin rust">(</span><span class="constant numeric integer decimal rust">0</span><span class="punctuation separator rust">,</span> <span class="meta path rust">Color<span class="punctuation accessor rust">::</span></span>Orange</span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span> <span class="keyword operator rust">|</span> <span class="meta group rust"><span class="punctuation section group begin rust">(</span><span class="keyword operator rust">_</span><span class="punctuation separator rust">,</span> <span class="meta path rust">Color<span class="punctuation accessor rust">::</span></span>Purple</span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span> <span class="keyword operator rust">=&gt;</span> <span class="meta block rust"><span class="punctuation section block begin rust">{</span>
                <span class="keyword operator rust">*</span><span class="support function rust">color</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span><span class="keyword operator rust">*</span>n</span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span> <span class="keyword operator rust">=</span> <span class="meta path rust">Color<span class="punctuation accessor rust">::</span></span>Purple<span class="punctuation terminator rust">;</span>
                <span class="storage modifier rust">unsafe</span> <span class="meta block rust"><span class="punctuation section block begin rust">{</span>
                    <span class="meta group rust"><span class="punctuation section group begin rust">(</span><span class="keyword operator rust">&amp;</span>raw <span class="storage modifier rust">mut</span> <span class="constant other rust">ROOTS</span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span>.<span class="support function rust">as_mut</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span>.<span class="support function rust">unwrap</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span>.<span class="support function rust">push</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span><span class="keyword operator rust">*</span>n</span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span><span class="punctuation terminator rust">;</span>
                </span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span>
            </span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span>
            <span class="keyword operator rust">_</span> <span class="keyword operator rust">=&gt;</span> <span class="meta block rust"><span class="punctuation section block begin rust">{</span>
                <span class="keyword operator rust">*</span><span class="support function rust">color</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span><span class="keyword operator rust">*</span>n</span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span> <span class="keyword operator rust">=</span> <span class="meta path rust">Color<span class="punctuation accessor rust">::</span></span>Black<span class="punctuation terminator rust">;</span>
                <span class="keyword operator rust">*</span><span class="support function rust">buffered</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span><span class="keyword operator rust">*</span>n</span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span> <span class="keyword operator rust">=</span> <span class="constant language rust">false</span><span class="punctuation terminator rust">;</span>
            </span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span>
        </span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span>
    </span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span>
</span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span></span>

<span class="storage modifier rust">unsafe</span> <span class="meta function rust"><span class="meta function rust"><span class="storage type function rust">fn</span> </span><span class="entity name function rust">free_cycle</span></span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters begin rust">(</span><span class="variable parameter rust">c</span><span class="punctuation separator rust">:</span> <span class="keyword operator rust">&amp;</span>[OpaqueGcPtr]</span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters end rust">)</span></span></span></span><span class="meta function rust"> </span><span class="meta function rust"><span class="meta block rust"><span class="punctuation section block begin rust">{</span>
    <span class="keyword control rust">for</span> n <span class="keyword operator rust">in</span> c <span class="meta block rust"><span class="punctuation section block begin rust">{</span>
        <span class="keyword operator rust">*</span><span class="support function rust">color</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span><span class="keyword operator rust">*</span>n</span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span> <span class="keyword operator rust">=</span> <span class="meta path rust">Color<span class="punctuation accessor rust">::</span></span>Red<span class="punctuation terminator rust">;</span>
    </span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span>
    <span class="keyword control rust">for</span> n <span class="keyword operator rust">in</span> c <span class="meta block rust"><span class="punctuation section block begin rust">{</span>
        <span class="support function rust">for_each_child</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span><span class="keyword operator rust">*</span>n<span class="punctuation separator rust">,</span> cyclic_decrement</span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span><span class="punctuation terminator rust">;</span>
    </span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span>
    <span class="keyword control rust">for</span> n <span class="keyword operator rust">in</span> c <span class="meta block rust"><span class="punctuation section block begin rust">{</span>
        <span class="support function rust">free</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span><span class="keyword operator rust">*</span>n</span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span><span class="punctuation terminator rust">;</span>
    </span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span>
</span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span></span>

<span class="storage modifier rust">unsafe</span> <span class="meta function rust"><span class="meta function rust"><span class="storage type function rust">fn</span> </span><span class="entity name function rust">cyclic_decrement</span></span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters begin rust">(</span><span class="variable parameter rust">m</span><span class="punctuation separator rust">:</span> OpaqueGcPtr</span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters end rust">)</span></span></span></span><span class="meta function rust"> </span><span class="meta function rust"><span class="meta block rust"><span class="punctuation section block begin rust">{</span>
    <span class="keyword control rust">if</span> <span class="keyword operator rust">*</span><span class="support function rust">color</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span>m</span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span> <span class="keyword operator rust">!</span><span class="keyword operator rust">=</span> <span class="meta path rust">Color<span class="punctuation accessor rust">::</span></span>Red <span class="meta block rust"><span class="punctuation section block begin rust">{</span>
        <span class="keyword control rust">if</span> <span class="keyword operator rust">*</span><span class="support function rust">color</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span>m</span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span> <span class="keyword operator rust">=</span><span class="keyword operator rust">=</span> <span class="meta path rust">Color<span class="punctuation accessor rust">::</span></span>Orange <span class="meta block rust"><span class="punctuation section block begin rust">{</span>
            <span class="keyword operator rust">*</span><span class="support function rust">rc</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span>m</span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span> <span class="keyword operator rust">-</span><span class="keyword operator rust">=</span> <span class="constant numeric integer decimal rust">1</span><span class="punctuation terminator rust">;</span>
            <span class="keyword operator rust">*</span><span class="support function rust">crc</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span>m</span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span> <span class="keyword operator rust">-</span><span class="keyword operator rust">=</span> <span class="constant numeric integer decimal rust">1</span><span class="punctuation terminator rust">;</span>
        </span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span> <span class="keyword control rust">else</span> <span class="meta block rust"><span class="punctuation section block begin rust">{</span>
            <span class="support function rust">decrement</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span>m</span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span><span class="punctuation terminator rust">;</span>
        </span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span>
    </span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span>
</span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span></span>

<span class="storage modifier rust">unsafe</span> <span class="meta function rust"><span class="meta function rust"><span class="storage type function rust">fn</span> </span><span class="entity name function rust">color</span></span><span class="meta generic rust"><span class="punctuation definition generic begin rust">&lt;</span><span class="storage modifier lifetime rust">&#39;a</span><span class="punctuation definition generic end rust">&gt;</span></span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters begin rust">(</span><span class="variable parameter rust">s</span><span class="punctuation separator rust">:</span> OpaqueGcPtr</span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters end rust">)</span></span></span></span><span class="meta function rust"> <span class="meta function return-type rust"><span class="punctuation separator rust">-&gt;</span> <span class="keyword operator rust">&amp;</span><span class="storage modifier lifetime rust">&#39;a</span> <span class="storage modifier rust">mut</span> Color</span> </span><span class="meta function rust"><span class="meta block rust"><span class="punctuation section block begin rust">{</span>
    <span class="keyword operator rust">&amp;</span><span class="storage modifier rust">mut</span> <span class="meta group rust"><span class="punctuation section group begin rust">(</span><span class="keyword operator rust">*</span>s.<span class="support function rust">as_ref</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span>.header.<span class="support function rust">get</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span>.color
</span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span></span>

<span class="storage modifier rust">unsafe</span> <span class="meta function rust"><span class="meta function rust"><span class="storage type function rust">fn</span> </span><span class="entity name function rust">rc</span></span><span class="meta generic rust"><span class="punctuation definition generic begin rust">&lt;</span><span class="storage modifier lifetime rust">&#39;a</span><span class="punctuation definition generic end rust">&gt;</span></span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters begin rust">(</span><span class="variable parameter rust">s</span><span class="punctuation separator rust">:</span> OpaqueGcPtr</span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters end rust">)</span></span></span></span><span class="meta function rust"> <span class="meta function return-type rust"><span class="punctuation separator rust">-&gt;</span> <span class="keyword operator rust">&amp;</span><span class="storage modifier lifetime rust">&#39;a</span> <span class="storage modifier rust">mut</span> <span class="storage type rust">usize</span></span> </span><span class="meta function rust"><span class="meta block rust"><span class="punctuation section block begin rust">{</span>
    <span class="keyword operator rust">&amp;</span><span class="storage modifier rust">mut</span> <span class="meta group rust"><span class="punctuation section group begin rust">(</span><span class="keyword operator rust">*</span>s.<span class="support function rust">as_ref</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span>.header.<span class="support function rust">get</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span>.rc
</span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span></span>

<span class="storage modifier rust">unsafe</span> <span class="meta function rust"><span class="meta function rust"><span class="storage type function rust">fn</span> </span><span class="entity name function rust">crc</span></span><span class="meta generic rust"><span class="punctuation definition generic begin rust">&lt;</span><span class="storage modifier lifetime rust">&#39;a</span><span class="punctuation definition generic end rust">&gt;</span></span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters begin rust">(</span><span class="variable parameter rust">s</span><span class="punctuation separator rust">:</span> OpaqueGcPtr</span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters end rust">)</span></span></span></span><span class="meta function rust"> <span class="meta function return-type rust"><span class="punctuation separator rust">-&gt;</span> <span class="keyword operator rust">&amp;</span><span class="storage modifier lifetime rust">&#39;a</span> <span class="storage modifier rust">mut</span> <span class="storage type rust">isize</span></span> </span><span class="meta function rust"><span class="meta block rust"><span class="punctuation section block begin rust">{</span>
    <span class="keyword operator rust">&amp;</span><span class="storage modifier rust">mut</span> <span class="meta group rust"><span class="punctuation section group begin rust">(</span><span class="keyword operator rust">*</span>s.<span class="support function rust">as_ref</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span>.header.<span class="support function rust">get</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span>.crc
</span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span></span>

<span class="storage modifier rust">unsafe</span> <span class="meta function rust"><span class="meta function rust"><span class="storage type function rust">fn</span> </span><span class="entity name function rust">buffered</span></span><span class="meta generic rust"><span class="punctuation definition generic begin rust">&lt;</span><span class="storage modifier lifetime rust">&#39;a</span><span class="punctuation definition generic end rust">&gt;</span></span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters begin rust">(</span><span class="variable parameter rust">s</span><span class="punctuation separator rust">:</span> OpaqueGcPtr</span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters end rust">)</span></span></span></span><span class="meta function rust"> <span class="meta function return-type rust"><span class="punctuation separator rust">-&gt;</span> <span class="keyword operator rust">&amp;</span><span class="storage modifier lifetime rust">&#39;a</span> <span class="storage modifier rust">mut</span> <span class="storage type rust">bool</span></span> </span><span class="meta function rust"><span class="meta block rust"><span class="punctuation section block begin rust">{</span>
    <span class="keyword operator rust">&amp;</span><span class="storage modifier rust">mut</span> <span class="meta group rust"><span class="punctuation section group begin rust">(</span><span class="keyword operator rust">*</span>s.<span class="support function rust">as_ref</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span>.header.<span class="support function rust">get</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span>.buffered
</span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span></span>

<span class="storage modifier rust">unsafe</span> <span class="meta function rust"><span class="meta function rust"><span class="storage type function rust">fn</span> </span><span class="entity name function rust">semaphore</span></span><span class="meta generic rust"><span class="punctuation definition generic begin rust">&lt;</span><span class="storage modifier lifetime rust">&#39;a</span><span class="punctuation definition generic end rust">&gt;</span></span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters begin rust">(</span><span class="variable parameter rust">s</span><span class="punctuation separator rust">:</span> OpaqueGcPtr</span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters end rust">)</span></span></span></span><span class="meta function rust"> <span class="meta function return-type rust"><span class="punctuation separator rust">-&gt;</span> <span class="keyword operator rust">&amp;</span><span class="storage modifier lifetime rust">&#39;a</span> Semaphore</span> </span><span class="meta function rust"><span class="meta block rust"><span class="punctuation section block begin rust">{</span>
    <span class="keyword operator rust">&amp;</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span><span class="keyword operator rust">*</span>s.<span class="support function rust">as_ref</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span>.header.<span class="support function rust">get</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span>.semaphore
</span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span></span>

<span class="meta function rust"><span class="meta function rust"><span class="storage type function rust">fn</span> </span><span class="entity name function rust">acquire_permit</span></span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters begin rust">(</span><span class="variable parameter rust">semaphore</span><span class="punctuation separator rust">:</span> <span class="keyword operator rust">&amp;</span>&#39;<span class="keyword operator rust">_</span> Semaphore</span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters end rust">)</span></span></span></span><span class="meta function rust"> <span class="meta function return-type rust"><span class="punctuation separator rust">-&gt;</span> <span class="meta generic rust">SemaphorePermit<span class="punctuation definition generic begin rust">&lt;</span>&#39;<span class="keyword operator rust">_</span><span class="punctuation definition generic end rust">&gt;</span></span></span> </span><span class="meta function rust"><span class="meta block rust"><span class="punctuation section block begin rust">{</span>
    <span class="keyword control rust">loop</span> <span class="meta block rust"><span class="punctuation section block begin rust">{</span>
        <span class="keyword control rust">if</span> <span class="storage type rust">let</span> <span class="support type rust">Ok</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span>permit</span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span> <span class="keyword operator rust">=</span> semaphore.<span class="support function rust">try_acquire</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span> <span class="meta block rust"><span class="punctuation section block begin rust">{</span>
            <span class="keyword control rust">return</span> permit<span class="punctuation terminator rust">;</span>
        </span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span>
    </span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span>
</span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span></span>

<span class="storage modifier rust">unsafe</span> <span class="meta function rust"><span class="meta function rust"><span class="storage type function rust">fn</span> </span><span class="entity name function rust">for_each_child</span></span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters begin rust">(</span><span class="variable parameter rust">s</span><span class="punctuation separator rust">:</span> OpaqueGcPtr, <span class="variable parameter rust">visitor</span><span class="punctuation separator rust">:</span> unsafe <span class="storage type function rust">fn</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span></span><span class="meta group rust">OpaqueGcPtr<span class="meta group rust"><span class="punctuation section group end rust">)</span></span></span></span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters end rust">)</span></span></span></span><span class="meta function rust"> </span><span class="meta function rust"><span class="meta block rust"><span class="punctuation section block begin rust">{</span>
    <span class="storage type rust">let</span> permit <span class="keyword operator rust">=</span> <span class="support function rust">acquire_permit</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span><span class="support function rust">semaphore</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span>s</span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span><span class="punctuation terminator rust">;</span>
    <span class="meta group rust"><span class="punctuation section group begin rust">(</span><span class="keyword operator rust">*</span>s.<span class="support function rust">as_ref</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span>.data.<span class="support function rust">get</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span>.<span class="support function rust">visit_children</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span>visitor</span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span><span class="punctuation terminator rust">;</span>
    <span class="support function rust">drop</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span>permit</span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span><span class="punctuation terminator rust">;</span>
</span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span></span>
</span></pre>
<p>While the collector has a snapshot of the reference counts of the system, we cannot guarantee 
that they are an accurate reflection of the system at the time of collection. Concurrent cycle
collection therefore works in two parts: </p>
<ul>
<li>Finding potential cycles, using essentially the same algorithm as the synchronous cycle
collector.</li>
<li>Determining if those cycles are safe to collect via two tests, the Σ-test and Δ-test. </li>
</ul>
<p>I’m not going to go into the proof or the explanation, because I don’t understand it well enough
to do a better explanation than the paper, but any cycle that passes these two tests are perfectly
safe to collect. </p>
<p>You may notice here that we acquire a read lock on the data for the <code>Gc</code> when we call <code>for_each_child</code>. 
Why is this necessary? Well, I’m not entirely sure that it is, but my intuition is that even reading
pointers that are being modified in another thread is entirely well defined behavior, even though
we know that any value of a pointer will be valid data. So I acquire a read lock. I think it’s fine.</p>
<h3>Bringing it all together</h3>
<p>As a nice consequence of allowing <code>Arc</code> to be a data type, we can add a very simple unit test of
our code. Let’s be clear, this is an insufficient amount of testing! But it does demonstrate that
we <em>do</em> have the ability to test our code:</p>
<pre class="code"><span class="source rust"><span class="meta annotation rust"><span class="punctuation definition annotation rust">#</span><span class="punctuation section group begin rust">[</span><span class="variable annotation rust">cfg</span><span class="meta annotation parameters rust"><span class="meta group rust"><span class="punctuation section group begin rust">(</span></span></span><span class="meta annotation parameters rust"><span class="meta group rust">test</span></span><span class="meta annotation parameters rust"><span class="meta group rust"><span class="punctuation section group end rust">)</span></span></span><span class="punctuation section group end rust">]</span></span>
<span class="meta module rust"><span class="storage type module rust">mod</span> <span class="entity name module rust">test</span> <span class="meta block rust"><span class="punctuation section block begin rust">{</span>
    <span class="keyword other rust">use</span> <span class="meta path rust"><span class="keyword other rust">super</span><span class="punctuation accessor rust">::</span></span><span class="keyword operator rust">*</span><span class="punctuation terminator rust">;</span>
    <span class="keyword other rust">use</span> <span class="keyword other rust">crate</span><span class="meta path rust"><span class="punctuation accessor rust">::</span></span><span class="meta path rust">gc<span class="punctuation accessor rust">::</span></span><span class="keyword operator rust">*</span><span class="punctuation terminator rust">;</span>
    <span class="keyword other rust">use</span> <span class="meta path rust">std<span class="punctuation accessor rust">::</span></span><span class="meta path rust">sync<span class="punctuation accessor rust">::</span></span>Arc<span class="punctuation terminator rust">;</span>

    <span class="meta annotation rust"><span class="punctuation definition annotation rust">#</span><span class="punctuation section group begin rust">[</span><span class="variable annotation rust">tokio</span>::<span class="variable annotation rust">test</span><span class="punctuation section group end rust">]</span></span>
    async <span class="meta function rust"><span class="meta function rust"><span class="storage type function rust">fn</span> </span><span class="entity name function rust">cycles</span></span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters begin rust">(</span></span><span class="meta function rust"><span class="meta function parameters rust"><span class="punctuation section parameters end rust">)</span></span></span></span><span class="meta function rust"> </span><span class="meta function rust"><span class="meta block rust"><span class="punctuation section block begin rust">{</span>
        <span class="meta annotation rust"><span class="punctuation definition annotation rust">#</span><span class="punctuation section group begin rust">[</span><span class="variable annotation rust">derive</span><span class="meta annotation parameters rust"><span class="meta group rust"><span class="punctuation section group begin rust">(</span></span></span><span class="meta annotation parameters rust"><span class="meta group rust">Default<span class="punctuation separator rust">,</span> Trace</span></span><span class="meta annotation parameters rust"><span class="meta group rust"><span class="punctuation section group end rust">)</span></span></span><span class="punctuation section group end rust">]</span></span>
        <span class="meta struct rust"><span class="storage type struct rust">struct</span> </span><span class="meta struct rust"><span class="entity name struct rust">Cyclic</span> </span><span class="meta struct rust"><span class="meta block rust"><span class="punctuation section block begin rust">{</span>
            <span class="variable other member rust">next</span><span class="punctuation separator rust">:</span> <span class="meta generic rust">Option<span class="punctuation definition generic begin rust">&lt;</span><span class="meta generic rust">Gc<span class="punctuation definition generic begin rust">&lt;</span>Cyclic<span class="punctuation definition generic end rust">&gt;</span></span><span class="punctuation definition generic end rust">&gt;</span></span>,
            <span class="variable other member rust">out</span><span class="punctuation separator rust">:</span> <span class="meta generic rust">Option<span class="punctuation definition generic begin rust">&lt;</span><span class="meta generic rust">Arc<span class="punctuation definition generic begin rust">&lt;</span><span class="punctuation section group begin rust">(</span><span class="punctuation section group end rust">)</span><span class="punctuation definition generic end rust">&gt;</span></span><span class="punctuation definition generic end rust">&gt;</span></span>,
        </span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span></span>

        <span class="storage type rust">let</span> out_ptr <span class="keyword operator rust">=</span> <span class="meta path rust">Arc<span class="punctuation accessor rust">::</span></span>new<span class="meta group rust"><span class="punctuation section group begin rust">(</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span><span class="punctuation terminator rust">;</span>

        <span class="storage type rust">let</span> a <span class="keyword operator rust">=</span> <span class="meta path rust">Gc<span class="punctuation accessor rust">::</span></span>new<span class="meta group rust"><span class="punctuation section group begin rust">(</span><span class="meta path rust">Cyclic<span class="punctuation accessor rust">::</span></span>default<span class="meta group rust"><span class="punctuation section group begin rust">(</span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span><span class="punctuation terminator rust">;</span>
        <span class="storage type rust">let</span> b <span class="keyword operator rust">=</span> <span class="meta path rust">Gc<span class="punctuation accessor rust">::</span></span>new<span class="meta group rust"><span class="punctuation section group begin rust">(</span><span class="meta path rust">Cyclic<span class="punctuation accessor rust">::</span></span>default<span class="meta group rust"><span class="punctuation section group begin rust">(</span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span><span class="punctuation terminator rust">;</span>
        <span class="storage type rust">let</span> c <span class="keyword operator rust">=</span> <span class="meta path rust">Gc<span class="punctuation accessor rust">::</span></span>new<span class="meta group rust"><span class="punctuation section group begin rust">(</span><span class="meta path rust">Cyclic<span class="punctuation accessor rust">::</span></span>default<span class="meta group rust"><span class="punctuation section group begin rust">(</span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span><span class="punctuation terminator rust">;</span>

        <span class="comment line double-slash rust"><span class="punctuation definition comment rust">//</span> a -&gt; b -&gt; c -
</span>        <span class="comment line double-slash rust"><span class="punctuation definition comment rust">//</span> ^----------/
</span>        a.<span class="support function rust">write</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span>.await.next <span class="keyword operator rust">=</span> <span class="support type rust">Some</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span>b.<span class="support function rust">clone</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span><span class="punctuation terminator rust">;</span>
        b.<span class="support function rust">write</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span>.await.next <span class="keyword operator rust">=</span> <span class="support type rust">Some</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span>c.<span class="support function rust">clone</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span><span class="punctuation terminator rust">;</span>
        b.<span class="support function rust">write</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span>.await.out <span class="keyword operator rust">=</span> <span class="support type rust">Some</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span>out_ptr.<span class="support function rust">clone</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span><span class="punctuation terminator rust">;</span>
        c.<span class="support function rust">write</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span>.await.next <span class="keyword operator rust">=</span> <span class="support type rust">Some</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span>a.<span class="support function rust">clone</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span><span class="punctuation terminator rust">;</span>

        <span class="support macro rust">assert_eq!</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span><span class="meta path rust">Arc<span class="punctuation accessor rust">::</span></span>strong_count<span class="meta group rust"><span class="punctuation section group begin rust">(</span><span class="keyword operator rust">&amp;</span>out_ptr</span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span><span class="punctuation separator rust">,</span> <span class="constant numeric integer decimal rust">2</span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span><span class="punctuation terminator rust">;</span>

        <span class="support function rust">drop</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span>a</span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span><span class="punctuation terminator rust">;</span>
        <span class="support function rust">drop</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span>b</span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span><span class="punctuation terminator rust">;</span>
        <span class="support function rust">drop</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span>c</span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span><span class="punctuation terminator rust">;</span>
        <span class="storage type rust">let</span> <span class="storage modifier rust">mut</span> mutation_buffer <span class="keyword operator rust">=</span> <span class="support type rust">Vec</span><span class="meta path rust"><span class="punctuation accessor rust">::</span></span>new<span class="meta group rust"><span class="punctuation section group begin rust">(</span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span><span class="punctuation terminator rust">;</span>
        <span class="storage modifier rust">unsafe</span> <span class="meta block rust"><span class="punctuation section block begin rust">{</span>
            <span class="support function rust">process_mutation_buffer</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span><span class="keyword operator rust">&amp;</span><span class="storage modifier rust">mut</span> mutation_buffer</span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span>.await<span class="punctuation terminator rust">;</span>
            <span class="support function rust">process_cycles</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span><span class="punctuation terminator rust">;</span>
            <span class="support function rust">process_cycles</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span><span class="punctuation terminator rust">;</span>
        </span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span>

        <span class="support macro rust">assert_eq!</span><span class="meta group rust"><span class="punctuation section group begin rust">(</span><span class="meta path rust">Arc<span class="punctuation accessor rust">::</span></span>strong_count<span class="meta group rust"><span class="punctuation section group begin rust">(</span><span class="keyword operator rust">&amp;</span>out_ptr</span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span><span class="punctuation separator rust">,</span> <span class="constant numeric integer decimal rust">1</span></span><span class="meta group rust"><span class="punctuation section group end rust">)</span></span><span class="punctuation terminator rust">;</span>
    </span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span></span>
</span><span class="meta block rust"><span class="punctuation section block end rust">}</span></span></span>
</span></pre>

  </body>
</html>